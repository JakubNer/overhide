swagger: '2.0'
host: overhide.io
basePath: /broker
schemes:
  - https
  - wss
info:
  description: |
    This is the API contract expected to be exposed by an overhide "broker".  This API is represented by the green "broker API" connector in the overhide component model:

    ![overhide component model](https://github.com/JakubNer/overhide/raw/master/docs/images/provided.png)

    Read this API with reference to the [glossary](glossary.html).

    ***
      #### A note on schemes used in the API.  
      
      Operations *GET*, *PUT*, *POST*, *DELETE* use the HTTPS scheme.  These endpoints should be understood as standard REST requests.  These configuration/discovery exchanges involve text parameters on the URL line and text/numeric payloads in the JSON representation.  They use BASE64 encoding: the BASE64 encoding is explicitly stated.

      Operations *WIRE* are WebSocket events that use a custom wire protocol.  The SSL secured WebSockets connection is to the same address as the HTTPS connection.  [Authentication](#tag-auth) occurs using HTTPS and seamlessly propagates to the [WSS connection](#security-definition-Authorization%20WSS).  

      Wire-protocol events require an additional step of a [handshake](#operation-handshake-WIRE) between client and broker:  beyond just being authenticated.  Failure to [handshake](#operation-handshake-WIRE) will result in "no handshake" 400-series error codes on wire-protocol events.

      Please review the [flow-control](#tag-flow-control) documentation to understand the *WIRE* protocol flow-control mechanisms.
    ***
      #### A note on the wire-protocol payload notation.  
      
      WSS event exchanged payloads are comprised of compact byte streams.  In the documentation payloads with byte streams are described as descriptors in the following format:

      | *syntax *    | *bytes* | *value* |
      | ---          | ---     | ---     |
      | foo          | 2       |         |
      | bar          | 1       | N       |
      | for i in N { |         |         |
      |   baz        | 4       |         |
      | }            |         | ``      |
              
      The above indicates that the first 3 bytes are followed by a loop of 4 byte words.  The number of iteration is specified by bits 16-23.

      All numeric values greater than a byte are sent in network order, big-endian format.  The *foo* above is 2-bytes wide, the first byte having the most significant bits.
    ***
  version: 1.0.0
  title: Overhide Broker API
  contact:
    email: info@overhide.io
  license:
    name: MIT License
    url: 'https://pages.github.com/JakubNer/overhide/blob/master/LICENSE'
tags:
  - name: capabilities
    description: |
      Discover capabilities of the overhide broker system.
      * subscription providers
      * subscription tiers
  - name: flow-control
    description: |
      Flow controls include toggles for the client and the broker to agree on message maximums, message fragmentation parameters, as well as acknowledgment and continuation messages for fragments of large payloads.

      The various flow-control events are modeled below:

      ![overhide flow-control infographic](https://github.com/JakubNer/overhide/raw/master/docs/images/flowcontrol.png)

      Before the *client* can exchange data with the *overhide broker* it needs to authenticate and handshake.

      The first synchronous HTTPS call is a PUT to [*/auth/credentials*](#operation--auth-credentials-put); returning an [identity](glossary.html#identity).  Subsequently, when the client establishes a Websocket connection with the broker (*Websocket connect(identity)*) it provides the [identity](glossary.html#identity) as per [WSS Auth](#security-definition-Authorization%20WSS).

      From this point on the exchanges take place over the Websocket protocol, ursng *WIRE* events as documented here.

      Before any data exchanges can take place, the client communicates its desired fragment and aggregate message parameters using the [*handshake* event](#operation-handshake-WIRE).  The server agrees--"shakes on it" with a ["response" *WIRE* event](#/responses/WIRE) having a code of *200/OK*.

      The client proceeds to send a large [*datastore-value*](glossary.html#datastore-value) that is necessairly fragmented into multiple *WIRE* events.  The exchange is started with a [set data event](#operation-set-data-WIRE).  The *flags* attribute of this [set data event](#operation-set-data-WIRE) does not have the `0x80` bit set: indicating that the payload byte-stream is the first fragment of multiple fragments for the large aggregate message.  The broker replies with a ["response" *WIRE* event](#/responses/WIRE) having a code of *200/OK*.  The client does not send the subsequent fragment until the broker confirms receipt of the previous fragment with such a ["response" *WIRE* event](#/responses/WIRE).

      The client sends subsequent fragments using the [continue](#operation-continue-WIRE) events.  Before sending each subsequent fragment the client expects a ["response" *WIRE* event](#/responses/WIRE) having a code of *200/OK*.

      The client sends the final fragment with a *flags* having the `0x80` bit toggled: indicating last fragment sent.

      The final exchange modeled is the client retrieving a large payload from the broker.  The exchange is initiated with a [get data event](#operation-get-data-WIRE).  The broker responds with a [*WIRE* event](#/responses/WIRE) having a code of *206/fragment*.  The client accepts the payload byte-stream as the first fragment of a larger response.  The client sends an [acknowledge event](#operation-acknowledge-WIRE) to the broker; acknowledging receipt of the fragment and freeing the broker to send the subsequent fragment.

      The broker does so, looping through the 206-acknowledge exchanges.

      When the broker sends the last fragment of the aggregate message byte-stream, it sends it with a code of *200/OK*.  The client doesn't have to [acknowledge](#operation-acknowledge-WIRE) this last response as it's not a *206/fragment*.
  - name: broker-lookup
    description: |
      Allow services to discover users' specific broker *host names* and *IPs* through [user-addresses](glossary.html#user-address).

      Target broker specifics are [set](#operation--broker-lookup--remuneration-key---user-address--put) into the *broker-lookup* network by whichever broker enters [active steward](glossary.html#data-steward) mode by the user with either:

      * [PUT /active-stewardship](#operation--active-stewardship-put)
      * [PUT /pour-active-stewardship](#operation--pour-active-stewardship-put)

      These APIs are optionally implemented by brokers.  The user's [active broker](glossary.html#data-steward) and the broker used to resolve a lookup (perhaps one and the same) need to support *broker-lookup* on a network with the same [remuneration-key](#/definitions/RemunerationKey): i.e. these APIs cannot return 405 -- "Method Not Allowed".

      Read more on *broker-lookup* in the [reference implementation write-up](lookup.html).
  - name: auth
    description: |
      Authentication, authorization, and credential management:

      * authenticate providing an [access token](#security-definition-Authorization Header): authenticate subscribers of 
        the system and invitees of subscribers of the system.
      * work with  authority levels.
      * opt-in persistence network storage
      * change [identity](glossary.html#identity) credentials.  Setting [identity](glossary.html#identity) for the first time is
      done with the [authenticate endpoint](#operation--auth-credentials-put).
      * work with subscription details for a supported remuneration API and a
      given [identity](glossary.html#identity).
  - name: scratch-pad 
    description: |
      A single identity specific data container for holding a small piece of data in working-memory.

      This data is volatile and not guaranteed: it's only ever stored in working-memory.

      In working-data volatile memory limited to 32KiB that doesn't survive broker instance restarts.
  - name: data
    description: |
      Data key-value CRUD operations; modifying data values in [datastore-keys](glossary.html#datastore-key).
  - name: backchannel queues
    description: |
      Publishing messages to backchannel queues, subscribing to notifications, and de-queueing the messages.
  - name: delegate
    description: |
      Delegate data in a [segment-key](glossary.html#segment-key) is data qualified by an [identity](glossary.html#identity) that is different from the owner.

      Each delegate keeps their data completely separate from other delegates under the same [segment-key](glossary.html#segment-key).

      Delegates may be alloted delegated *backchannel-queues*:  these are qualified via *delegate* query parameters on [the backchannel endpoints](#tag-backchannel-queues)
  - name: datastore-key settings
    description: |
      Setting access metadata for [datastore-keys](glossary.html#datastore-key).

      * write rights
      * publish rights
      * delegate access rights
      * entry-fee: minimum remuneration to access
      * read/write limits
      * opt-in for decentralized storge
  - name: metrics
    description: |
      Usage metrics for specific [datastore-keys](glossary.html#datastore-key) or overall for the [identity](glossary.html#identity).
  - name: data-stewardship
    description: |
      Stewardship of a users's data.

      Stewardship of data is important regardless whether an [identity](glossary.html#identity) opts-in into decentralized storage or not.
      All but [one](#operation--opt-in-data--type-key---guid--post) of these APIs deal with stwardship regardless of decentralization opt-in selected: see 
      [opt-in endpoint](#operation--auth-opt-in--agree--put) and [*segment-key* specific opt-in](#definition-DatastoreKeySettings).  
          
      * manage this broker's stewardship mode for an identity's data:  [active/passive stewardship](glossary.html#data-steward)
      * manage distributed persistence network particulars for a user
      * review [content propagation status](glossary.html#working-memory-permanent-memory-shared-memory-persistence-status)--of user's data and messages--to the distributed persistence network
      * batch import and export of all user's data and messages

      Envisioned use cases include backup and broker transfer.

      The stewardship APIs enable [data decentralization](decentralization.html) and [broker trustlessness](trustlessness.html).

      #### Sample Use Case: Designation of Stewards

      Consider the following sequence modelling *overhide* API calls required to associate client data with two *overhide* brokers; one designated as an [active data steward](glossary.html#data-steward) and one designated to be a [passive data steward](glossary.html#data-steward).

      Messages in red are API calls detailed in this section.  Other API calls are glanced over.  Blue messages are external.

      ![overhide designation of stewards infographic](https://github.com/JakubNer/overhide/raw/master/docs/images/designate-stewards.png)

      In this sequence the client subscribes to "overhide broker 1" and authenticates [1].  It's important to note that the first time a new user authenticates to a broker a new set of [GUIDs](#/definitions/GUID) is generated pointing to the client's data on the broker's distributed persistence network (e.g. [IPFS](https://ipfs.io/) "names" PKI pair for [IPFS](https://ipfs.io/)).

      At this point "overhide broker 1" is read-only.  Any attempts to write data or post messages would yield a 400 -- "cannot write, broker not an active steward of user's data".  To make the broker writable, it's designated as an [active data steward](glossary.html#data-steward) [2].

      The client writes then reads data as desired [3-5].  The data is eventually made consistent with the distributed persistence network (e.g. [IPFS](https://ipfs.io/)).

      Presumably the distributed persistence network backing "overhide broker 1" is a public decentralized data-store that allows common tooling access [7].  To access the client's data we need its reference.  The reference is retrieved as a [GUID](#/definitions/GUID) [6].

      Another *overhide* broker is subscribed to by the client--to guarantee pinning of the client's data as a backup [8].

      At this point "overhide broker 2" is subscribed to, but it is not associated with the client's data as referenced by "overhide broker 1" [9-11].  The second broker has a compeltelly different GUID for the client's data on the distributed persistence network.

      Once the client furnished the GUID form "overhide broker 1" to "overhide broker 2" [12], "overhide broker 2" starts acting as a passive steward of the client's data [13-17].

      #### Sample Use Case: Disassociation from Steward

      The client may have a reason to diassociate from an *overhide* broker.  In the following sequence we model the API calls required to disassociate client data from "overhide broker 1":  including ensuring the disassociated broker cannot clobber any new data and that old client data is not consuming resources on the broker. 

      ![overhide disassociation from steward infographic](https://github.com/JakubNer/overhide/raw/master/docs/images/steward-disassociation.png)

      We start with "overhide broker 1" being the [active data steward](glossary.html#data-steward) and "overhide broker 2" being the [passive data steward](glossary.html#data-steward) [1-5].

      Before making "overhide broker 2" the new active steward [7], we ensure "overhide broker 1" is made passive [6]:  it's desirable to have just one active steward writing to the distributed persistence network.

      Once "overhide broker 2" is told to be an active steward, we want it to track client data under a new GUID [8-9].  The old GUID is well known to "overhide broker 1" and we want full disassociation.

      Client data is encrypted across *overhide*.  At this point it's also only writable by "overhide broker 2".  Neverless, we may desire to delete all of it from "overhide broker 1" [10].  
paths:
  handshake:
    options:
      summary: Client initiates handshake with broker.
      description: |
        The handshake should take place immediatelly after upgrading an authenticated HTTPS connection to WSS, before raising any other *WIRE* events.

        The handshake constitutes message maximums and message fragmentation parameters.

        The client sends the maximums to the broker.  If the broker agrees to the values it responds with a *200*: finalizing the handshake (see responses).  
        
        If the values are not acceptable to the broker, the broker responds with a *413*; suggesting alternate values (see responses).  The handshake is broken off at this point.  The client needs to re-start the handshake, adjusting the values sent in.  

        All *WIRE* events following a successful handshake need to keep their message exchanges consistent with the constraints of the handshake, else risk a "message outside handshake constraints" (400) response.
      tags:
        - flow-control
      parameters:
        - in: body
          name: payload
          description: |

            | *syntax*            | *bytes* | *value* |
            | ---                 | ---     | ---     |
            | req-id              | 8       |         |
            | len                 | 8       | 17      |
            | opcode              | 1       | 0xFF    |
            | max-fragment-size   | 4       |         |
            | max-aggregate-size  | 8       |         |
            | ack-timeout-millis  | 4       | ``      |
          schema:
            type: object
            required:
              - req-id
              - len
              - opcode
              - max-fragment-size
              - max-aggregate-size
              - ack-timeout-millis
            properties:
              req-id:
                type: number
                description: |
                  Request ID: a connection specific unique identifier of the request/responses.  Has no meaning beyond connection.
              len:
                type: number
                description: |
                  Length in bytes constituting the remainder of this message: number of bytes that follow this *len*.
              opcode:                  
                type: bytes
                description: |
                  Operation code.
              max-fragment-size:
                type: number
                description: |
                  A large message payload must be split up into fragments at most *max-fragment-size* bytes long.

                  A suggested default is 256KiB.
              max-aggregate-size:
                type: number
                description: |
                  The maximum size of a message payload--the aggregate of all fragments.
              ack-timeout-millis:
                type: number
                description: |
                  Milliseconds specifying period within which a fragment acknowledgment is expected before sender can halt exchange.
      consumes:
        - application/octet-stream
      produces:
        - application/octet-stream
      security:
        - Authorization WSS: []
      responses:
        RESPONSE:
          $ref: "#/responses/WIRE"
        code == 200:
          description: |
            Handshake achieved:  broker agrees with the flow-control values as per this handshake request from the client.
        code == 413:
          description: |
            The broker rejects the flow-control values.

            Suggested values are returned in the *response* byte-stream:

            | *syntax*            | *bytes* | *value* |
            | ---                 | ---     | ---     |
            | max-fragment-size   | 4       |         |
            | max-aggregate-size  | 8       | ``      |
            | ack-timeout-millis  | 4       | ``      |

            Handshake is not established, the client should retry the handshake with the values suggested by the broker.
        code == 429:
          $ref: "#/responses/429"  
  continue:
    options:
      summary: Continue sending fragments of a message to a "setter" endpoint of a broker.
      description: |
        For the following *WIRE* events the message payload may be fragmented into multiple requests:
        
          * [WIRE set data](#operation-set-data-WIRE)
          * [WIRE post message](#operation-post-message-WIRE)
          * [WIRE import](#operation-import-WIRE)
        
        The first request is one of the above *WIRE* event calls.  Subsequent requests are this *continuation* call.  All the requests are sequential fragments of the same aggregate message.  The order of the initial *WIRE* event call and these subsequent *continuation* fragments is guaranteed.

        Any "setter" *WIRE* event that may have it's request fragmented will indicate that it respects the 0x80 (done) *flag* value in it's properties description.  Any *WIRE* event that doesn't consider the 0x80 (done) *flag* may not have its message stream--initiated by endpoint call with a *req-id*--continued with these *continue* fragment messages. 
        
        The first *WIRE* event transmits the first bytes of the payload and indicates that there are more fragments required by keeping the 0x80 *flag* (done) unset.

        Subsequent *continuation* fragments transfer the remainder of the aggregate message byte-stream to the broker.  The last message has it's 0x80 *flag* (done) set.

        The client must not send subsequent fragments until the broker responds with a *200* code to the previous request.
      tags:
        - flow-control
      parameters:
        - in: body
          name: payload
          description: |

            | *syntax*        | *bytes* | *value* |
            | ---             | ---     | ---     |
            | req-id          | 8       |         |
            | len             | 8       | length(payload) + 2 |
            | opcode          | 1       | 0x10    |
            | flags           | 1       |         |
            | payload         | *       | ``      |
          schema:
            type: object
            required:
              - req-id
              - len
              - opcode
              - flags
              - payload
            properties:
              req-id:
                type: number
                description: |
                  Request ID: a connection specific unique identifier of the request/responses.  Has no meaning beyond connection.

                  This is the request ID we're continuing with this fragment.
              len:
                type: number
                description: |
                  Length in bytes constituting the remainder of this message: number of bytes that follow this *len*.
              opcode:                  
                type: bytes
                description: |
                  Operation code.
              flags:
                type: bytes
                description: |
                  A byte of flags.  

                  | *value* | *name* | *description* |
                  | ---  | ---  | --- |
                  | 0x80 | done | `0x1`: this is the last fragment of the payload for req-id |
              payload:
                type: bytes
                description: |
                  The fragment byte-stream.
      consumes:
        - application/octet-stream
      produces:
        - application/octet-stream
      security:
        - Authorization WSS: []
      responses:
        RESPONSE:
          $ref: "#/responses/WIRE"
        code == 200:
          description: |
            Success.  Empty.
        code == 400:
          $ref: "#/responses/400"
        code == 429:
          $ref: "#/responses/429"
  acknowledge:
    options:
      summary: Acknowledge receipt of a response fragment from a "getter" endpoint of a broker.
      description: |
        The response payload of the following *WIRE* events--as well as broker initiated messages (see [subscribe endpoint](#operation-subscribe-WIRE))--may be fragmented into multiple responses:
          
          * [WIRE get data](#operation-get-data-WIRE)
          * [WIRE fetch messages](#operation-fetch-messages-WIRE)
          * [WIRE get delegate data](#operation-get-delegate-data-WIRE)
          * [WIRE get all delegate values](#operation-get-all-delegate-values-WIRE)
          * [WIRE segment-keys](#operation-segment-keys-WIRE)
          * [WIRE export](#operation-export-WIRE)

        All WSS response events from the broker and broker-initiated events adhere to the [*WIRE* response](#/responses/WIRE) specification.  
        
        Any [*WIRE* response](#/responses/WIRE) with *code 206* (fragment response) must be acknowledged by this *acknowledge* message: the broker will not send additional messages until receipt of acknowledgment.

        Any [broker-initiated *WIRE* message](#/responses/WIRE) with code 222--[subscription event](#operation-subscribe-WIRE)--must be acknowledged by this *acknowledge* message: the broker will not send additional messages until receipt of acknowledgment.

        *WIRE* events enumerating that they expect a response with *code* *206* (fragment response) or *222* (subscription event) need concern themselves with these acknowledgments.  *WIRE* events not enumerating a response *code* *206* or *222* will never have a fragmented response.

        Note that this message does not expect a response from the broker.
      tags:
        - flow-control
      parameters:
        - in: body
          name: payload
          description: |

            | *syntax*        | *bytes* | *value* |
            | ---             | ---     | ---     |
            | req-id          | 8       |         |
            | len             | 8       | 1       |
            | opcode          | 1       | 0x20    |
          schema:
            type: object
            required:
              - req-id
              - len
              - opcode
            properties:
              req-id:
                type: number
                description: |
                  Request ID: a connection specific unique identifier of the request/responses.  Has no meaning beyond connection.

                  This is the request ID who's fragmented response we're acknowledging.
              len:
                type: number
                description: |
                  Length in bytes constituting the remainder of this message: number of bytes that follow this *len*.
              opcode:                  
                type: bytes
                description: |
                  Operation code.
      produces:
        - application/octet-stream
      security:
        - Authorization WSS: []
      responses:
  halt:
    options:
      summary: Halt fragmented sending or receiving.
      description: |
        Any fragmented sending or receiving--as per the [continue](#operation-continue-WIRE) or [acknowledge](#operation-acknowledge-WIRE) endpoints--may be halted.

        A halt signals further fragments should not be sent, should be dropped.

        Only the client can initiate a halt.  The broker may similarly halt on timeout conditions as per [handshake](#operation-handshake-WIRE).
      tags:
        - flow-control
      parameters:
        - in: body
          name: payload
          description: |

            | *syntax*        | *bytes* | *value* |
            | ---             | ---     | ---     |
            | req-id          | 8       |         |
            | len             | 8       | 1       |
            | opcode          | 1       | 0x30    |
          schema:
            type: object
            required:
              - req-id
              - len
              - opcode
            properties:
              req-id:
                type: number
                description: |
                  Request ID: a connection specific unique identifier of the request/responses.  Has no meaning beyond connection.

                  This is the request ID who's fragmented response we're acknowledging.
              len:
                type: number
                description: |
                  Length in bytes constituting the remainder of this message: number of bytes that follow this *len*.
              opcode:                  
                type: bytes
                description: |
                  Operation code.
      consumes:
        - application/octet-stream
      produces:
        - application/octet-stream
      security:
        - Authorization WSS: []
      responses:
        RESPONSE:
          $ref: "#/responses/WIRE"
        code == 200:
          description: |
            Halt seen.
        code == 400:
          $ref: "#/responses/400"
        code == 429:
          $ref: "#/responses/429"  
  watchdog:
    options:
      summary: Check if connection is live.
      description: |
        Check if connection is live.  Broker has until [*ack-timeout-millis* (as per handshake)](#operation-handshake-WIRE) to respond with a 200/woof.
      tags:
        - flow-control
      parameters:
        - in: body
          name: payload
          description: |

            | *syntax*        | *bytes* | *value* |
            | ---             | ---     | ---     |
            | req-id          | 8       |         |
            | len             | 8       | 1       |
            | opcode          | 1       | 0x50    |
          schema:
            type: object
            required:
              - req-id
              - len
              - opcode
            properties:
              req-id:
                type: number
                description: |
                  Request ID: a connection specific unique identifier of the request/responses.  Has no meaning beyond connection.

                  This is the request ID who's fragmented response we're acknowledging.
              len:
                type: number
                description: |
                  Length in bytes constituting the remainder of this message: number of bytes that follow this *len*.
              opcode:                  
                type: bytes
                description: |
                  Operation code.
      consumes:
        - application/octet-stream
      produces:
        - application/octet-stream
      security:
        - Authorization WSS: []
      responses:
        RESPONSE:
          $ref: "#/responses/WIRE"
        code == 200:
          description: |
            Woof: connection is live.
        code == 429:
          $ref: "#/responses/429"  
  /capabilities/remuneration-providers:
    get:
      summary: List of remuneration providers supported.
      description: |
        Mapping of remuneration providers to the broker's public address for given
        provider.
      tags:
        - capabilities
      operationId: getRemunerationProviders
      produces:
        - application/json
      responses:
        200:
          description: |
            Array of objects each defining one remuneration provider mapping.
          schema:
            type: array
            items:
              $ref: "#/definitions/RemunerationProvider"
        429:
          $ref: "#/responses/429"
  /capabilities/{remuneration-key}/tiers:
    get:
      summary: List of subscription tiers available.
      description: |
         List of subscription tiers available for this broker from a given
         remuneration provider.
      tags:
        - capabilities
      operationId: getRemunerationTiers
      parameters:
        - in: path
          name: remuneration-key
          required: true
          schema:
            $ref: "#/definitions/RemunerationKey"
      produces:
        - application/json
      responses:
        200:
          description: |
            Array of objects each defining one remuneration tier mapping.
          schema:
            type: array
            items:
              $ref: "#/definitions/RemunerationTier"
        400:
          $ref: "#/responses/400"
        429:
          $ref: "#/responses/429"
  /capabilities/unixtime-millis:
    get:
      summary: Retrieve this broker's unixtime in milliseconds.
      description: |
        Retrieve this broker's unixtime in milliseconds.
      tags:
        - capabilities
      produces:
        - text/plain
      responses:
        200:
          description: |
            The number as string: this broker's UNIX epoch time in milliseconds.
        429:
          $ref: "#/responses/429"
  /capabilities/address:
    get:
      summary: Retrieve this broker's broker-address for the remuneration-provider used by caller's identity.
      description: |
        Retrieve this broker's [broker-address](glossary.html#broker-address) for the remuneration-provider used by caller's [identity](glossary.html#identity).
      tags:
        - capabilities
      produces:
        - text/plain
      responses:
        200:
          description: |
            This broker's [broker-address](glossary.html#broker-address) for the remuneration-provider used by caller's identity.
        429:
          $ref: "#/responses/429"
  /broker-lookup/{remuneration-key}/{user-address}:
    get:
      summary: Resolve user-addres to broker host name or IP.
      description: |
        Resolve a [user-address](glossary.html#user-address) from a ledger represented by the provided [remuneration-key](#/definitions/RemunerationKey) to a broker host name or IP.

        The returned broker information points to the user's currently [active steward](#tag-data-stewardship) and [drain-host](glossary.html#drain-host), if any.
      parameters:
        - in: path
          name: remuneration-key
          required: true
          schema:
            $ref: "#/definitions/RemunerationKey"
        - in: path
          name: user-address
          required: true
          description: |
            A public *user-address* whom to lookup.

            Must be an address for the remuneration provider indicated in *remuneration-key*.
      tags:
        - broker-lookup
      produces:
        - application/json
      responses:
        200:
          description: |
            Returns broker information for the [user-address](glossary.html#user-address):

            ```
            {
              "address": "..",      
              "activeBrokerAddress": "..",       
              "activeBrokerAddressSigned": "..", 
              "activeBrokerHost": "..",
              "activeBrokerHostSigned": "..",    
              "drainBrokerHost": "..",
              "drainBrokerHostSigned": ".."      
            }
            ```

            * *address* is the [user-address](glossary.html#user-address).
            * *activeBrokerAddress* is the [broker-address](glossary.html#broker-address) of the [active steward](glossary.html#data-steward).
            * *activeBrokerAddressSigned* is *activeBrokerAddress* signed by *address*
                * since *address* signs *activeBrokerAddress*, only the owner of this [user-address](glossary.html#user-address) can update their [active steward's](glossary.html#data-steward) [broker-address](glossary.html#broker-address).
            * *activeBrokerHost* is the *host name* or *IP* of [active steward](glossary.html#data-steward) broker.
                * this is the *host name* or *IP* to use for the rest of these API calls.
            * *activeBrokerHostSigned* is *activeBrokerHost* signed by *activeBrokerAddress*
                * since *activeBrokerAddress* signs *activeBrokerHost*, the [active steward](glossary.html#data-steward) can change the *host name* or *IP* without involving the user.
                * this indirection is useful for load-balancing and other operations aspects of the broker.
            * *drainBrokerHost* is the *host name* or *IP* of the [drain-host](glossary.html#drain-host), if any.
            * *drainBrokerHostSigned* is *drainBrokerHost* signed by *address*
                * since *address* signs *drainBrokerHost*, only the owner of this [user-address](glossary.html#user-address) can update their [drain-host](glossary.html#drain-host).
        404:
          $ref: "#/responses/404-cannot-resolve"
        405:
          $ref: "#/responses/405"
        429:
          $ref: "#/responses/429"
    put:
      summary: Populate broker-lookup entry on the network.
      description: |
        Populate [broker-lookup](glossary.html#broker-lookup) entry for network indicated by the [remuneration-key](#/definitions/RemunerationKey); corrsponding to calling [identity](glossary.html#identity)'s'[user-address](glossary.html#user-address).
      tags:
        - broker-lookup
      parameters:
        - in: body
          name: lookup
          description: |
            Lookup parameters.
          schema:
            type: object
            required:
              - active-broker-address-signed
              - unixtime-millis
              - unixtime-millis-signed
            properties:
              active-broker-address-signed:
                type: string
                description: |
                  BASE64 encoded.

                  Signature of this brokers address as retrieved with [GET /capabilities/address](#operation--capabilities-address-get).

                  The broker's address is signed by the calling *identity's* [user-address](glossary.html#user-address).

                  The signing [user-address](glossary.html#user-address) and the signed broker's address must be for ledger corresponding to [remuneration-key](#/definitions/RemunerationKey) of calling [identity](glossary.html#identity).                   

                  Signature algorithm is [remuneration-key](#/definitions/RemunerationKey) specific; for Ethereum it's *keccak-256*, for Bitcoin it's *secp256k1*.  Refer to the ledger's remuneration API.
              drain-broker-host:
                type: string
                description: |
                  A host name or IP of a broker we want to advertise as the [drain-host](glossary.html#drain-host): this can be retrieved with [GET /capabilities/address](#operation--capabilities-address-get) on the origin [passive steward](#tag-data-stewardship).
              drain-broker-host-signed:
                type: string
                description: |
                  BASE64 encoded.

                  Signature of the above *drain-broker-host*.

                  Must be signed by the calling *identity's* [user-address](glossary.html#user-address).

                  The signing [user-address](glossary.html#user-address) must be for ledger corresponding to [remuneration-key](#/definitions/RemunerationKey) of calling [identity](glossary.html#identity).                   

                  Signature algorithm is [remuneration-key](#/definitions/RemunerationKey) specific; for Ethereum it's *keccak-256*, for Bitcoin it's *secp256k1*.  Refer to the ledger's remuneration API.
              unixtime-millis:
                type: number
                description: |
                  Non-unique UNIX Epoch timestamp (milliseconds) that must be within 300000 milliseconds of the current system time of the broker.  This gives the caller five minutes of tolerance either in the future or in the past.  You can use [/capabilities/unixtime-millis](#operation--capabilities-unixtime-millis-get) as the source for this parameter.

                  These parameters mitigate replay attacks.
              unixtime-millis-signed:
                type: string
                description: |
                  BASE64 encoded.

                  The *unixtime-millis* provided above signed with the private key corrsponding to the [user-address](glossary.html#user-address) of [identity](glossary.html#identity).

                  Signature algorithm is [remuneration-key](#/definitions/RemunerationKey) specific; for Ethereum it's *keccak-256*, for Bitcoin it's *secp256k1*.  Refer to the ledger's remuneration API.
      consumes:
        - application/json
      responses:
        200:
          description: |
            Set OK.
        400:
          $ref: "#/responses/400"
        405:
          $ref: "#/responses/405"
        429:
          $ref: "#/responses/429"
  /auth/credentials:
    put:
      summary: Authenticate an [identity](glossary.html#identity) returning a token.
      description: |
        Authenticate an [identity](glossary.html#identity) returning a token to be used for [token
        authentication](#security-definition-Authorization Header) in the rest of the API.
      tags:
        - auth
      parameters:
        - in: body
          name: authentication
          description: |
            Authentication parameters.
          schema:
            type: object
            required:
              - remuneration-key
              - secret-phrase
              - user-address
              - secret-phrase-signed
              - unixtime-millis
              - unixtime-millis-signed
            properties:
              remuneration-key:
                type: string
                description: |
                  [Key](#/definitions/RemunerationKey) from remuneration-providers which contains subscription payment(s) from the
                  provided *user-address* to this broker's [broker-address](glossary.html#broker-address).

                  Must be one of the remuneration provider keys from this broker's [capabilities](#operation--capabilities-remuneration-providers-get).
              secret-phrase:
                type: string
                description: |
                  BASE64 encoded.

                  A secret phrase for the specified *user-address*.  Once a user authenticates against the broker with a secret-phrase and a *user-address*, the secret-phrase is tied to the *user-address* indefinitely, unless changed by [changed-credentials](#operation--auth-changed-credentials-put).  Using the incorrect *scecret-phrase* will result in a 400 -- "invalid secret-phrase".  ([more information](glossary.html#identity#identity-tracked-by-broker))
              user-address:
                type: string
                description: |
                  A public *user-address* to verify an active subscription to this broker's [broker-address](glossary.html#broker-address).

                  Must be an address for the remuneration provider indicated in *remuneration-key*.
              secret-phrase-signed:
                type: string
                description: |
                  BASE64 encoded.

                  The *secret-phrase* provided above signed with the private key corrsponding to the
                  *user-address*.

                  Signature algorithm is [remuneration-key](#/definitions/RemunerationKey) specific; for Ethereum it's *keccak-256*, for Bitcoin it's *secp256k1*.  Refer to the ledger's remuneration API.
              unixtime-millis:
                type: number
                description: |
                  Non-unique UNIX Epoch timestamp (milliseconds) that must be within 300000 milliseconds of the current system time of the broker.  This gives the caller five minutes of tolerance either in the future or in the past.  You can use [/capabilities/unixtime-millis](#operation--capabilities-unixtime-millis-get) as the source for this parameter.

                  These parameters mitigate replay attacks.
              unixtime-millis-signed:
                type: string
                description: |
                  BASE64 encoded.

                  The *unixtime-millis* provided above signed with the private key corrsponding to the *user-address* of [identity](glossary.html#identity).

                  Signature algorithm is [remuneration-key](#/definitions/RemunerationKey) specific; for Ethereum it's *keccak-256*, for Bitcoin it's *secp256k1*.  Refer to the ledger's remuneration API.
      consumes:
        - application/json
      produces:
        - application/json
      responses:
        200:
          description: |
            Authentication token is returned to be used in subsequent calls into
            overhide broker.
          schema:
            type: string
        400:
          $ref: "#/responses/400"
        402:
          description: |
            Payment Required -- Remuneration provider indicates insufficient transactions to the broker system to meet a
            service tier subscription requirements.

            See [subscriptions write-up](glossary.html#identity#subscriptions).
        409:
          $ref: "#/responses/409-identity-conflict"
        429:
          $ref: "#/responses/429"
  /auth/authorities:
    get:
      summary: Retrieves authorities for an [identity](glossary.html#identity).
      description: |
        Retrieve authorities for an [identity](glossary.html#identity).  Authorities are rates and limits as specified by [the *Authorities* return object](#definition-Authorities).

        If an [identity](glossary.html#identity) has multiple transactions with a reumneration provider, the transactions are added to yield the best service tier.

        Authorities are valid for the duration of the [security token](#security-definition-Authorization Header).

        See [identities write-up](glossary.html#identity) for more information.
      tags:
        - auth
      security:
        - Authorization Header: []
      produces:
        - application/json
      responses:
        200:
          description: |
            Authorized rates and limits are returned.
          schema:
            $ref: "#/definitions/Authorities"
        401:
           $ref: "#/responses/401"
        429:
          $ref: "#/responses/429"
  /auth/guest-credentials:
    put:
      summary: Authenticate an invitee's user-address as a guest of a subscriber's user-address.
      description: |
        Authenticate an invitee's [user-address](glossary.html#user-address) as a guest of a subscriber's [user-address](glossary.html#user-address).

        An invitee into the system must provide a valid address on an [accepted remuneration provider](#operation--capabilities-remuneration-providers-get).  An invitee must prove ownership of said valid address.

        Transactions--on a supported remuneration-provider--from the *invitee-user-address* to the provided *inviter-user-address* are part of the state of the returned access token by this call.  The *inviter* may set [fee expectations](#definition-DatastoreKeySettings) on [segment-key](glossary.html#segment-key).  If fees paid are expected, the *invitee* must necessairly have transacted with the *inviter*.

        The inviting subscriber must expose their [user-address](glossary.html#user-address) and a *shared-phrase* that's used to hash their [user-address](glossary.html#user-address)
        into an [identity](glossary.html#identity).  The *shared-phrase* is equivalent to the
        *secret-phrase* passed into the [authenticate endpoint](#operation--auth-credentials-put): except it's not kept secret by the 
        inviting user.  This is necessary to authorize the invitee to the inviting subscriber, and to ensure the inviting subscriber's 
        [user-address](glossary.html#user-address) does in fact hash to the desired indentity: we don't want to just pass the inviting subscriber's [identity](glossary.html#identity),
        we want to calculate it.

        Returns an "invitee" token to be used for [token authentication](#security-definition-Authorization Header) in the rest of the API.
        
        The *invitee-user-address*  hashed by *invitee-secret-phrase* is the invitee's [identity](glossary.html#identity)
        for the purposes of [write/publish permissions](#definition-DatastoreKeySettings) on [segment-key](glossary.html#segment-key).
      tags:
        - auth
      parameters:
        - in: body
          name: authentication
          description: |
            Authentication parameters.
          schema:
            type: object
            required:
              - remuneration-key
              - shared-phrase
              - inviter-user-address
              - invitee-secret-phrase
              - invitee-user-address
              - invitee-secret-phrase-signed
              - unixtime-millis
              - unixtime-millis-signed
            properties:
              remuneration-key:
                type: string
                description: |
                  [Key](#/definitions/RemunerationKey) from remuneration-providers which contains subscription payment(s) from the
                  provided [user-address](glossary.html#user-address) to this broker's [broker-address](glossary.html#broker-address).

                  Must be one of the remuneration provider keys from this broker's [capabilities](#operation--capabilities-remuneration-providers-get).
              shared-phrase:
                type: string
                description: |
                  BASE64 Encoded.

                  A shared phrase by the inviter to the invitee for the specified *inviter-user-address*.  The *shared-phrase* and the *inviter-user-address*
                  must compute to an authorized [identity](glossary.html#identity) on the system.  This is
                  the identity inviting the invitee.
              inviter-user-address:
                type: string
                description: |
                  A public [user-address](glossary.html#user-address) to verify an active subscription to this broker's [broker-address](glossary.html#broker-address).

                  Must be an address for the remuneration provider indicated in *remuneration-key*.

                  Used in combination with *shared-phrase*, see *shared-phrase* above.
              invitee-secret-phrase:
                type: string
                description: |
                  BASE64 Encoded.

                  A secret phrase for the specified *invitee-user-address*.

                  The broker shall allow the same *invitee-user-address* to be used with multiple different *invitee-secret-phrases*.  The broker can hash the *invitee-user-address* in a broker-specific way and make this hashed version available in the [visitor's authentication token](#security-definition-Authorization%20Header) for use with this API: for duplicate delegate-identity checks.  The hashed *invitee-user-address* is not stored off outside the broker's metadata (i.e. on the distributed persistence network). 
                  
                  See also the [*duplicate-delegate-policy* configuration point](#tag-datastore-key-settings) for [datastore-keys](glossary.html#datastore-key).
              invitee-user-address:
                type: string
                description: |
                  A public [user-address](glossary.html#user-address), must be an address for the remuneration provider indicated in *remuneration-key*.

                  Transactions from this address to *inviter-user-address* are stored in the returned access token to [check fees](#definition-DatastoreKeySettings) on invitee-accessed [segment-key](glossary.html#segment-key).
              invitee-secret-phrase-signed:
                type: string
                description: |
                  BASE64 encoded.

                  The *invitee-secret-phrase* provided above signed with the private key corrsponding to the
                  *invitee-user-address*.

                  Signature algorithm is [remuneration-key](#/definitions/RemunerationKey) specific; for Ethereum it's *keccak-256*, for Bitcoin it's *secp256k1*.  Refer to the ledger's remuneration API.
              unixtime-millis:
                type: number
                description: |
                  Non-unique UNIX Epoch timestamp (milliseconds) that must be within 300000 milliseconds of the current system time of the broker.  This gives the caller five minutes of tolerance either in the future or in the past.  You can use [/capabilities/unixtime-millis](#operation--capabilities-unixtime-millis-get) as the source for this parameter.

                  These parameters mitigate replay attacks.
              unixtime-millis-signed:
                type: string
                description: |
                  BASE64 encoded.

                  The *unixtime-millis* provided above signed with the private key corrsponding to the [user-address](glossary.html#user-address) of [identity](glossary.html#identity).

                  Signature algorithm is [remuneration-key](#/definitions/RemunerationKey) specific; for Ethereum it's *keccak-256*, for Bitcoin it's *secp256k1*.  Refer to the ledger's remuneration API.
              since:
                type: string
                description: |
                  If an [*entry-fee*](#tag-datastore-key-settings) is specified for a [datastore-key](glossary.html#datastore-key), transactions from *invitee-user-address*
                  to *inviter-user-address* need to be tallied.  All historical transactions are tallied unless this parameter is specified.

                  Retrieve transactions since this date-time (inclusive) until now.

                  The date-time is a string in [ISO 8601/RFC3339 format](https://xml2rfc.tools.ietf.org/public/rfc/html/rfc3339.html#anchor14).
      consumes:
        - application/json
      produces:
        - application/json
      responses:
        200:
          description: |
            Invitee authentication token is returned to be used in subsequent calls into
            overhide broker.
          schema:
            type: string
        400:
          $ref: "#/responses/400"
        402:
          description: |
            Payment Required -- Remuneration provider indicates no transactions exist between the user addresses in parameters.

            See [subscriptions write-up](glossary.html#identity#subscriptions).
        409:
          $ref: "#/responses/409-identity-conflict"
        429:
          $ref: "#/responses/429"
  /auth/changed-credentials:
    put:
      summary: Change authentication of token's user.
      description: |
      tags:
        - auth
      parameters:
        - in: body
          name: new-authentication
          description: |
            New authentication credentials for user indicated by the [identity](glossary.html#identity) in the [security header](#security-definition-Authorization Header).

            NOTE:  If the user's data is [tracked by multiple brokers](glossary.html#data-steward) the user's identity has to be changed on all 
            [data-stewards](glossary.html#data-steward) of the user's data.  Changing [identity](glossary.html#identity) on one [data-steward](glossary.html#data-steward) and 
            failing to do same on the rest yields brokers that track stale data.
          schema:
            type: object
            required:
              - new-remuneration-key
              - new-secret-phrase
              - new-user-address
              - new-secret-phrase-signed
              - unixtime-millis
              - unixtime-millis-signed
            properties:
              new-remuneration-key:
                type: string
                description: |
                  [Key](#/definitions/RemunerationKey) from remuneration-providers which contains subscription payment(s) from the
                  provided *new-user-address* to this broker's [broker-address](glossary.html#broker-address).

                  Must be one of the remuneration provider keys from this broker's [capabilities](#operation--capabilities-remuneration-providers-get).
              new-secret-phrase:
                type: string
                description: |
                  BASE64 Encoded.

                  A new secret phrase for the new [user-address](glossary.html#user-address).  Once credentials are changed successfully; the *new-secret-phrase* is tied to the *new-user-address* indefinitely, unless changed again by [changed-credentials](#operation--auth-changed-credentials-put).
              new-user-address:
                type: string
                description: |
                  A public [user-address](glossary.html#user-address) to verify an active subscription to this broker's [broker-address](glossary.html#broker-address).

                  Must be an address for the remuneration provider indicated in *new-remuneration-key*.
              new-secret-phrase-signed:
                type: string
                description: |
                  BASE64 encoded.

                  The *new-secret-phrase* provided above signed with the private key corrsponding to the
                  *new-user-address*.

                  Signature algorithm is [remuneration-key](#/definitions/RemunerationKey) specific; for Ethereum it's *keccak-256*, for Bitcoin it's *secp256k1*.  Refer to the ledger's remuneration API.
              unixtime-millis:
                type: number
                description: |
                  Non-unique UNIX Epoch timestamp (milliseconds) that must be within 300000 milliseconds of the current system time of the broker.  This gives the caller five minutes of tolerance either in the future or in the past.  You can use [/capabilities/unixtime-millis](#operation--capabilities-unixtime-millis-get) as the source for this parameter.

                  These parameters mitigate replay attacks.
              unixtime-millis-signed:
                type: string
                description: |
                  BASE64 encoded.

                  The *unixtime-millis* provided above signed with the private key corrsponding to the [user-address](glossary.html#user-address) of [identity](glossary.html#identity).

                  Signature algorithm is [remuneration-key](#/definitions/RemunerationKey) specific; for Ethereum it's *keccak-256*, for Bitcoin it's *secp256k1*.  Refer to the ledger's remuneration API.
      security:
        - Authorization Header: []
      consumes:
        - application/json
      responses:
        200:
          description: |
            Credentials successfully changed.
        400:
          $ref: "#/responses/400"
        401:
           $ref: "#/responses/401"
        409:
          $ref: "#/responses/409-identity-conflict"
        429:
          $ref: "#/responses/429"
  /auth/opt-in/{agree}:
    put:
      summary:  Opt-in to store all data for an identity via the broker's decentralized persistence.
      description: |
        Opt-in to store all data for an [identity](glossary.html#identity) via the broker's decentralized persistence.

        By default all data for an [identity](glossary.html#identity) is stored on this broker's local persistence.

        Unless opted-in, data is not decentralized: it does not end up on the broker's decentralized persistence.

        For fine-grained control you may instead selectivelly [opt-in each key *segment-key*](#definition-DatastoreKeySettings).

        You can still inspect all your data; [import](#operation-import-WIRE) or [export](#operation-export-WIRE) it manually.

        To automatically make all of an *identity's* data eventually consistent with the decentralized persistence network, 
        ensure to opt-in that [identity](glossary.html#identity) with this endpoint.
      tags:
        - auth
      parameters:
        - in: path
          name: agree
          required: true
          description: |
            Truthy string such as 'true' matching the regex `/t/i` will opt-in.  To opt-out send in a falsey string such as 'false' not matching
            that regex.

            All data for authenticated [identity](glossary.html#identity) will be opted in.
          type: string
      security:
        - Authorization Header: []
      consumes:
        - application/json
      responses:
        200:
          description: |
            Opt-in changed.
        400:
          $ref: "#/responses/400"
        401:
           $ref: "#/responses/401"
        409:
          $ref: "#/responses/409-identity-conflict"
        429:
          $ref: "#/responses/429"
  /auth/{remuneration-key}/{from-address}/{to-address}/transactions:
    get:
      summary: Retrieve remuneration transactions.
      description: |
        Retrieve the latest remuneration transactions on [remuneration-key](#/definitions/RemunerationKey) from *from-address* to *to-address*
      tags:
        - auth
      parameters:
        - in: path
          name: remuneration-key
          required: true
          description: |
            [Key](#/definitions/RemunerationKey) from remuneration-providers which contains payment(s) from the
            provided *from-address* to the provided *to-address*.

            Must be one of the remuneration provider keys from this broker's [capabilities](#operation--capabilities-remuneration-providers-get).
          type: string
        - in: path
          name: from-address
          required: true
          description: |
            A public address from which to verify payment details (amount/date) to the *to-address*.

            Must be an address from the remuneration provider indicated in *remuneration-key*.
          type: string
        - in: path
          name: to-address
          required: true
          description: |
            The target public address to check for payment made.

            Must be an address from the remuneration provider indicated in *remuneration-key*.

            This could be this broker system's public payment address with
            the reumneration provider (as retrieved via [remuneration provider](#definition-RemunerationProvider)).

            This could be any other public address furnished by the remuneration provider, e.g.
            the service's public address: to check for app purchase etc.
          type: string
        - in: query
          name: max-most-recent
          required: false
          type: integer
          description: |
            Number of most recent transactions to retrieve.
        - in: query
          name: since
          required: false
          type: string
          description: |
            Retrieve transactions since this date-time (inclusive) until now.

            The date-time is a string in [ISO 8601/RFC3339 format](https://xml2rfc.tools.ietf.org/public/rfc/html/rfc3339.html#anchor14).
      security:
        - Authorization Header: []
      produces:
        - application/json
      responses:
        200:
          description: |
            List of transactions.
          schema:
            type: array
            items:
              $ref: "#/definitions/Transaction"
        400:
          $ref: "#/responses/400"
        401:
           $ref: "#/responses/401"
        409:
          $ref: "#/responses/409-identity-conflict"
        429:
          $ref: "#/responses/429"
  /scratch-pad:
    get:
      summary: Get scratch-pad binary data for a user.
      description: |
        Retrieve *scratch-pad* data.
      
        *Scratch-pad* data is limited to 32KiB of temporary data.  Data is never be persisted and will only live in volatile memory: *working-data*.  *Scratch-pad* data is not qualified beyond authenticated [identity](glossary.html#identity): a single *scratch-pad* per identity.
      tags:
        - scratch-pad
      security:
        - Authorization Header: []
      produces:
        - application/octet-stream
      responses:
        200:
          description: |
            Data payload retrieved.
        246:
          $ref: "#/responses/246"
        400:
          $ref: "#/responses/400"
        401:
           $ref: "#/responses/401"
        409:
          $ref: "#/responses/409-identity-conflict"
        422:
          $ref: "#/responses/422"
        429:
          $ref: "#/responses/429"            
    put:
      summary: Set scratch-pad data for a user.
      description: |
        Set *scratch-pad* binary data.
      
        *Scratch-pad* data is limited to 32KiB of temporary data.  Data is never be persisted and will only live in volatile memory: *working-data*.  *Scratch-pad* data is not qualified beyond authenticated [identity](glossary.html#identity): a single *scratch-pad* per identity.
      tags:
        - scratch-pad
      parameters:
        - in: body
          name: payload
          description: |
            Data payload for scratch-pad.
      security:
        - Authorization Header: []
      consumes:
        - application/octet-stream
      responses:
        200:
          description: |
            Data successfully set.
        400:
          $ref: "#/responses/400"
        401:
           $ref: "#/responses/401"
        409:
          $ref: "#/responses/409-identity-conflict"
        429:
          $ref: "#/responses/429"          
  set data:
    options:
      summary: Set value of datastore-key.
      description: |
        Payload contents is written as a new value into [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)).

        For the *set* to succeed the [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)) must
        either be brand new of already owned by authorization token owner.

        If this broker is not an [(pour) active steward](#tag-data-stewardship) of data for [identity](glossary.html#identity), call fails with a 400 -- "cannot write, broker not an active steward of user's data"
      tags:
        - data
      parameters:
        - in: body
          name: payload
          description: |

            | *syntax*          | *bytes* | *value* |
            | ---               | ---     | ---     |
            | req-id            | 8       |         |
            | len               | 8       | SL + IL + length(payload) + 4 + [32] |
            | opcode            | 1       | 0x01    |
            | segment-key-len   | 1       | SL == length(segment-key) |
            | segment-key       | SL      |         |
            | identity-len      | 1       | IL == length(identity) |
            | identity          | IL      |         |
            | flags             | 1       |         |
            | if flags & 0x10 { |         |         |
            |   write-gate      | 32      |         |
            | }                 |         |         |
            | payload           | *       | ``      |
          schema:
            type: object
            required:
              - req-id
              - len
              - opcode
              - segment-key-len
              - segment-key
              - identity-len
              - flags
              - payload
            properties:
              req-id:
                type: number
                description: |
                  Request ID: a connection specific unique identifier of the request/responses.  Has no meaning beyond connection.
              len:
                type: number
                description: |
                  Length in bytes constituting the remainder of this message: number of bytes that follow this *len*.  32 bytes are added for a *write-gate* if *flags* has `0x10` set.
              opcode:                  
                type: bytes
                description: |
                  Operation code.
              segment-key-len:
                type: number
                description: |
                  Length in bytes of *segment-key*.
              segment-key:
                type: bytes
                description: |
                  See [glossary](glossary.html#segment-key).
              identity-len:
                type: number
                description: |
                  Length in bytes of [identity](glossary.html#identity).
              identity:
                type: bytes
                description: |
                  Optional identity.  If not provided, identity is that of token owner.

                  See [glossary](glossary.html#identity).
              flags:
                type: bytes
                description: |
                  A byte of flags.  

                  | *value* | *name* | *description* |
                  | --- | --- | --- |
                  | 0x04 | wait-until-persisted | `1`: wait until datastore-key changes are persisted |
                  | 0x08 | wait-until-shared | `1`: wait until datastore-key changes are shared on distributed persistence network |
                  | 0x10 | gate-the-write | `1`: use SHA256 in *write-gate* to check value at *segment-key* for equality before overriding. |
                  | 0x80 | done | `1`: this payload is not fragmented; `0`: this payload is a fragment and subsequent [continue](#operation-continue-WIRE) messages will follow after the broker responds with a *200*. |
              write-gate:
                type: bytes
                description: |
                  Optional write "gate": a 32 byte SHA256 hash value of the content being replaced by this set operation.  If this hash does not match the current value at this *segment-key*, this
                  set operation will fail with error code 409.
              payload:
                type: bytes
                description: |
                  The payload byte-stream.
      consumes:
        - application/octet-stream
      produces:
        - application/octet-stream
      security:
        - Authorization WSS: []
      responses:
        RESPONSE:
          $ref: "#/responses/WIRE"
        code == 200:
          description: |
            Success.  Empty.
        code == 400:
          $ref: "#/responses/400"
        code == 403:
          $ref: "#/responses/403"
        code == 409:
          $ref: "#/responses/409"
        code == 429:
          $ref: "#/responses/429"
  get data:
    options:
      summary: Get value of datastore-key.
      description: |
        Get value of [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)).
      tags:
        - data
      parameters:
        - in: body
          name: payload
          description: |

            | *syntax*        | *bytes* | *value* |
            | ---             | ---     | ---     |
            | req-id          | 8       |         |            
            | len             | 8       | SL + IL + 3 |
            | opcode          | 1       | 0x02    |
            | segment-key-len | 1       | SL == length(segment-key) |
            | segment-key     | SL      |         |
            | identity-len    | 1       | IL == length(identity) |
            | identity        | IL      | ``      |
          schema:
            type: object
            required:
              - req-id
              - len
              - opcode
              - segment-key-len
              - segment-key
              - identity-len
            properties:
              req-id:
                type: number
                description: |
                  Request ID: a connection specific unique identifier of the request/responses.  Has no meaning beyond connection.
              len:
                type: number
                description: |
                  Length in bytes constituting the remainder of this message: number of bytes that follow this *len*.
              opcode:                  
                type: bytes
                description: |
                  Operation code.
              segment-key-len:
                type: number
                description: |
                  Length in bytes of *segment-key*.
              segment-key:
                type: bytes
                description: |
                  See [glossary](glossary.html#segment-key).
              identity-len:
                type: number
                description: |
                  Length in bytes of [identity](glossary.html#identity).
              identity:
                type: bytes
                description: |
                  Optional identity.  If not provided, identity is that of token owner.

                  See [glossary](glossary.html#identity).
      consumes:
        - application/octet-stream
      produces:
        - application/octet-stream
      security:
        - Authorization WSS: []
      responses:
        RESPONSE:
          $ref: "#/responses/WIRE"
        code == 200:
          description: |
            The value of [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)).
        code == 206:
          $ref: "#/responses/206"
        code == 246:
          $ref: "#/responses/246"
        code == 400:
          $ref: "#/responses/400"
        code == 403:
          $ref: "#/responses/403"
        code == 404:
          $ref: "#/responses/404-datastore-key"
        code == 422:
          $ref: "#/responses/422"
        code == 429:
          $ref: "#/responses/429"
  delete data:
    options:
      summary: Delete datastore-key.
      description: |
        Delete [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)).  The [datastore-key](glossary.html#datastore-key) must be
        owned by the token owner.

        If this broker is not an [(pour) active steward](#tag-data-stewardship) of data for [identity](glossary.html#identity), call fails with a 400 -- "cannot write, broker not an active steward of user's data"
      tags:
        - data
      parameters:
        - in: body
          name: payload
          description: |

            | *syntax*        | *bytes* | *value* |
            | ---             | ---     | ---     |
            | req-id          | 8       |         |
            | len             | 8       | SL + IL + 4 |
            | opcode          | 1       | 0x03    |
            | segment-key-len | 1       | SL == length(segment-key) |
            | segment-key     | SL      |         |
            | identity-len    | 1       | IL == length(identity) |
            | identity        | IL      | ``      |
            | flags           | 1       | ``      |
          schema:
            type: object
            required:
              - req-id
              - len
              - opcode
              - segment-key-len
              - segment-key
              - identity-len
              - flags
            properties:
              req-id:
                type: number
                description: |
                  Request ID: a connection specific unique identifier of the request/responses.  Has no meaning beyond connection.
              len:
                type: number
                description: |
                  Length in bytes constituting the remainder of this message: number of bytes that follow this *len*.
              opcode:                  
                type: bytes
                description: |
                  Operation code.
              segment-key-len:
                type: number
                description: |
                  Length in bytes of *segment-key*.
              segment-key:
                type: bytes
                description: |
                  See [glossary](glossary.html#segment-key).
              identity-len:
                type: number
                description: |
                  Length in bytes of [identity](glossary.html#identity).
              identity:
                type: bytes
                description: |
                  Optional identity.  If not provided, identity is that of token owner.

                  See [glossary](glossary.html#identity).
              flags:
                type: bytes
                description: |
                  A byte of flags.  

                  | *value* | *name* | *description* |
                  | --- | --- | --- |
                  | 0x04 | wait-until-persisted | `1`: wait until datastore-key changes are persisted |
                  | 0x08 | wait-until-shared | `1`: wait until datastore-key changes are shared on distributed persistence network |                  
      consumes:
        - application/octet-stream
      produces:
        - application/octet-stream
      security:
        - Authorization WSS: []
      responses:
        RESPONSE:
          $ref: "#/responses/WIRE"
        code == 200:
          description: |
            Success.  Empty.
        code == 400:
          $ref: "#/responses/400"
        code == 403:
          $ref: "#/responses/403"
        code == 404:
          $ref: "#/responses/404-datastore-key"
        code == 429:
          $ref: "#/responses/429"
  post message:
    options:
      summary: Enqueue a message to a given datastore-key backchannel.
      description: |
        Enqueue a message to a given [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)) backchannel.

        If the [datastore-key](glossary.html#datastore-key)'s *allow-publish* setting is "self", the [identity](glossary.html#identity) in the authentication token must match the [datastore-key](glossary.html#datastore-key) owner.

        If the [datastore-key](glossary.html#datastore-key)'s *allow-publish* setting is "signed", the author of the backchannel message is the [identity](glossary.html#identity) tied ot the authorization token passed to this API.  Message author's [identity](glossary.html#identity) is present in the token and compared to the *allowed-publishers* list--if any--for this [datastore-key](glossary.html#datastore-key).

        If the [datastore-key](glossary.html#datastore-key)'s *allow-publish* setting is "any", the [identity](glossary.html#identity) in the authentication token must simply be valid: a valid broker system user is publishing.

        See the [settings getter](#operation---segment-key--settings--get) for the above settings.

        If this broker is not an [(pour) active steward](#tag-data-stewardship) of data for [identity](glossary.html#identity), call fails with a 400 -- "cannot write, broker not an active steward of user's data"
      tags:
        - backchannel queues
      parameters:
        - in: body
          name: payload
          description: |

            | *syntax*        | *bytes* | *value* |
            | ---             | ---     | ---     |
            | req-id          | 8       |         |
            | len             | 8       | SL + IL + DL + length(payload) + 5 |
            | opcode          | 1       | 0x04    |
            | segment-key-len | 1       | SL == length(segment-key) |
            | segment-key     | SL      |         |
            | identity-len    | 1       | IL == length(identity) |
            | identity        | IL      |         |
            | delegate-len    | 1       | DL == length(delegate) |
            | delegate        | DL      |         |
            | flags           | 1       | ``      |
            | payload         | *       | ``      |
          schema:
            type: object
            required:
              - req-id
              - len
              - opcode
              - segment-key-len
              - segment-key
              - identity-len
              - delegate-len
              - flags
              - payload
            properties:
              req-id:
                type: number
                description: |
                  Request ID: a connection specific unique identifier of the request/responses.  Has no meaning beyond connection.
              len:
                type: number
                description: |
                  Length in bytes constituting the remainder of this message: number of bytes that follow this *len*.
              opcode:                  
                type: bytes
                description: |
                  Operation code.
              segment-key-len:
                type: number
                description: |
                  Length in bytes of *segment-key*.
              segment-key:
                type: bytes
                description: |
                  See [glossary](glossary.html#segment-key).
              identity-len:
                type: number
                description: |
                  Length in bytes of [identity](glossary.html#identity).
              identity:
                type: bytes
                description: |
                  Optional identity.  If provided, must be complementary to the *delegate* parameter,  or one of public restricted identities:  0 .. 9999.  If not provided, identity is that of [token owner](#security-definition-Authorization%20WSS).

                  See [glossary](glossary.html#identity).
              delegate-len:
                type: number
                description: |
                  Length in bytes of *delegate*.
              delegate:
                type: bytes
                description: |
                  Qualifies that this backchannel message is meant for a [delegate](#tag-delegate) of *segment-key*.  The value is the delegate's [identity](glossary.html#identity).

                  This value could be a glob `*`.  The `*` glob value means the message is posted to all delegates:  it's enqueued on all their queues.

                  The *delegate* is the message recepient and must satisfy [settings on the [segment-key](glossary.html#segment-key)](#definition-DatastoreKeySettings) allowing delegate publication of mesages.

                  If this parameter is present, the [identity](glossary.html#identity) request parameter is mandatory.  The [segment-key](glossary.html#segment-key) and the [identity](glossary.html#identity) request parameters constitute the *datstore-key*.

                  The [authorized](#security-definition-Authorization%20WSS) user is the sender.
              flags:
                type: bytes
                description: |
                  A byte of flags.  

                  | *value* | *name* | *description* |
                  | --- | --- | --- |
                  | 0x04 | wait-until-persisted | `1`: wait until datastore-key changes are persisted |
                  | 0x08 | wait-until-shared | `1`: wait until datastore-key changes are shared on distributed persistence network |                  
                  | 0x80 | done | `1`: this payload is not fragmented; `0`: this payload is a fragment and subsequent [continue](#operation-continue-WIRE) messages will follow after the broker responds with a *200*. |
              payload:
                type: bytes
                description: |
                  The payload byte-stream.
      consumes:
        - application/octet-stream
      produces:
        - application/octet-stream
      security:
        - Authorization WSS: []
      responses:
        RESPONSE:
          $ref: "#/responses/WIRE"
        code == 200:
          description: |
            Success.  Empty.
        code == 400:
          $ref: "#/responses/400"
        code == 403:
          $ref: "#/responses/403"
        code == 404:
          $ref: "#/responses/404-datastore-key"
        code == 429:
          $ref: "#/responses/429"
  fetch messages:
    options:
      summary: Retrieve all messages from the backchannel at the givent datastore-key.
      description: |
        Retrieve all messages from the backchannel at the given [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)).

        Retrieves messages if [authorized identity](#security-definition-Authorization%20WSS) is the owner of the [datastore-key](glossary.html#datastore-key).

        Retrieves *delegated* messages if [authorized identity](#security-definition-Authorization%20WSS) is not the owner of the [datastore-key](glossary.html#datastore-key) but is complementary with the *datastore-key's* [delegate configuration](#tag-datastore-key-settings).
      tags:
        - backchannel queues
      parameters:
        - in: body
          name: payload
          description: |

            | *syntax*        | *bytes* | *value* |
            | ---             | ---     | ---     |
            | req-id          | 8       |         |
            | len             | 8       | SL + IL + 3 |
            | opcode          | 1       | 0x05    |
            | segment-key-len | 1       | SL == length(segment-key) |
            | segment-key     | SL      |         |
            | identity-len    | 1       | IL == length(identity) |
            | identity        | IL      |         |
          schema:
            type: object
            required:
              - req-id
              - len
              - opcode
              - segment-key-len
              - segment-key
              - identity-len
            properties:
              req-id:
                type: number
                description: |
                  Request ID: a connection specific unique identifier of the request/responses.  Has no meaning beyond connection.
              len:
                type: number
                description: |
                  Length in bytes constituting the remainder of this message: number of bytes that follow this *len*.
              opcode:                  
                type: bytes
                description: |
                  Operation code.
              segment-key-len:
                type: number
                description: |
                  Length in bytes of *segment-key*.
              segment-key:
                type: bytes
                description: |
                  See [glossary](glossary.html#segment-key).
              identity-len:
                type: number
                description: |
                  Length in bytes of [identity](glossary.html#identity).
              identity:
                type: bytes
                description: |
                  Optional identity.  If provided, qualifies the [datastore-key](glossary.html#datastore-key) owner--complementary to delegation.  
                  
                  May be one of public identities:  0 .. 9999.  
                  
                  If not provided, [authorized identity](#security-definition-Authorization%20WSS) defaults as owner.

                  See [glossary](glossary.html#identity).
      consumes:
        - application/octet-stream
      produces:
        - application/octet-stream
      security:
        - Authorization WSS: []
      responses:
        RESPONSE:
          $ref: "#/responses/WIRE"
        code == 200:
          description: |
            Messages enqueued at [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)) ordered by increasing non-unique *unixtime-millis*.

            Messages returned may not have unique *unixtime-millis*--more than one message may have the same *unixtime-millis*.  

            The broker guarantees that the messages in the payload comprise *all* unacknowledged message with a *unixtime-millis* 
            up-to and including the highest *unixtime-millis*.

            | *syntax*          | *bytes* | *value* |
            | ---               | ---     | ---     |
            | loop {            |         |         |
            |   unixtime-millis | 8       |         |
            |   message-len     | 8       | ML = length(message) |
            |   message         | *       |         |
            | }                 |         | ``      |

          schema:
            type: object
            required:
              - unixtime-millis
              - message-len
              - message
            properties:
              unixtime-millis:
                type: number
                description: |
                  Non-unique UNIX Epoch timestamp (milliseconds) of the message.
              message-len:
                type: number
                description: |
                  Length in bytes of *message*.
              message:
                type: bytes
                description: |
                  The message byte stream value.
        code == 206:
          $ref: "#/responses/206"
        code == 246:
          $ref: "#/responses/246"
        code == 400:
          $ref: "#/responses/400"
        code == 403:
          $ref: "#/responses/403"
        code == 404:
          $ref: "#/responses/404-datastore-key"
        code == 422:
          $ref: "#/responses/422"
        code == 429:
          $ref: "#/responses/429"
  acknowledge messages:
    options:
      summary: Acknowledge all messages with timestamps up to and including a specified unixtime-millis for given datastore-key.
      description: |
        Acknowledge all messages with timestamp up to and including a specified *unixtime-millis* have been handled.  All messages up to and including the specified *unixtime-millis* will be removed from the backchannel.

        Acknowledge messages if [authorized identity](#security-definition-Authorization%20WSS) is the owner of the [datastore-key](glossary.html#datastore-key).

        Acknowledge *delegated* messages if [authorized identity](#security-definition-Authorization%20WSS) is not the owner of the [datastore-key](glossary.html#datastore-key) but is complementary with the *datastore-key's* [delegate configuration](#tag-datastore-key-settings).

        If this broker is not an [(pour) active steward](#tag-data-stewardship) of data for [identity](glossary.html#identity), call fails with a 400 -- "cannot write, broker not an active steward of user's data"
      tags:
        - backchannel queues
      parameters:
        - in: body
          name: payload
          description: |

            | *syntax*        | *bytes* | *value* |
            | ---             | ---     | ---     |
            | req-id          | 8       |         |            
            | len             | 8       | SL + IL + 12 |
            | opcode          | 1       | 0x06    |
            | segment-key-len | 1       | SL == length(segment-key) |
            | segment-key     | SL      |         |
            | identity-len    | 1       | IL == length(identity) |
            | identity        | IL      |         |
            | flags           | 1       |         |
            | unixtime-millis | 8       | ``      |
          schema:
            type: object
            required:
              - req-id
              - len
              - opcode
              - segment-key-len
              - segment-key
              - identity-len
              - flags
              - unixtime-millis
            properties:
              req-id:
                type: number
                description: |
                  Request ID: a connection specific unique identifier of the request/responses.  Has no meaning beyond connection.
              len:
                type: number
                description: |
                  Length in bytes constituting the remainder of this message: number of bytes that follow this *len*.
              opcode:                  
                type: bytes
                description: |
                  Operation code.
              segment-key-len:
                type: number
                description: |
                  Length in bytes of *segment-key*.
              segment-key:
                type: bytes
                description: |
                  See [glossary](glossary.html#segment-key).
              identity-len:
                type: number
                description: |
                  Length in bytes of [identity](glossary.html#identity).
              identity:
                type: bytes
                description: |
                  Optional identity.  If provided, qualifies the [datastore-key](glossary.html#datastore-key) owner--complementary to delegation.  
                  
                  May be one of public identities:  0 .. 9999.  
                  
                  If not provided, [authorized identity](#security-definition-Authorization%20WSS) defaults as owner.

                  See [glossary](glossary.html#identity).
              flags:
                type: bytes
                description: |
                  A byte of flags.  

                  | *value* | *name* | *description* |
                  | --- | --- | --- |
                  | 0x04 | wait-until-persisted | `1`: wait until datastore-key changes are persisted |
                  | 0x08 | wait-until-shared | `1`: wait until datastore-key changes are shared on distributed persistence network |                  
              unixtime-millis:
                type: number
                description: |
                  *unixtime-millis* up to which--inclusive--to acknowledge backchannel processing.
      consumes:
        - application/octet-stream
      produces:
        - application/octet-stream
      security:
        - Authorization WSS: []
      responses:
        RESPONSE:
          $ref: "#/responses/WIRE"
        code == 200:
          description: |
            Success.  Empty.
        code == 400:
          $ref: "#/responses/400"
        code == 403:
          $ref: "#/responses/403"
        code == 404:
          $ref: "#/responses/404-datastore-key"
        code == 429:
          $ref: "#/responses/429"
  subscribe:
    options:
      summary:  Owner--identified in token--subscribes to notifications of new messages in datastore-key.
      description: |
        Owner--identified in token--subscribes to notifications of new messages in [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)).  

        Subscribes to messages if [authorized identity](#security-definition-Authorization%20WSS) is the owner of the [datastore-key](glossary.html#datastore-key).

        Subscribes to *delegated* messages if [authorized identity](#security-definition-Authorization%20WSS) is not the owner of the [datastore-key](glossary.html#datastore-key) but is complementary with the *datastore-key's* [delegate configuration](#tag-datastore-key-settings).

        If the *shunt* query parameter is not specified, subscription doesn't send actual message content, just notification of new messages with a new *unixtime-millis*.

        If the *shunt* query parameter is specified, full message content is sent via subscription.  Unless the *auto-acknowledge* flag is set, the messages do have to be explicitly [acknowledged](#operation-acknowledge-messages-WIRE) to clear the backchannel queue.  Failure to acknowledge messages with *auto-acknowledge* off and [limit-bytes set](#definition-DatastoreKeySettings) may lead to a full backchannel queue and dropped messages; not forwarded to these live subscriptions.

        If this broker is not an [(pour) active steward](#tag-data-stewardship) of data for [identity](glossary.html#identity) and the *auto-acknowledge* flag is set, call fails with a 400 --         "cannot write, broker not an active steward of user's data"
      tags:
        - backchannel queues
      parameters:
        - in: body
          name: payload
          description: |

            | *syntax*        | *bytes* | *value* |
            | ---             | ---     | ---     |
            | req-id          | 8       |         |
            | len             | 8       | SL + IL + 4 |
            | opcode          | 1       | 0x07    |
            | segment-key-len | 1       | SL == length(segment-key) |
            | segment-key     | SL      |         |
            | identity-len    | 1       | IL == length(identity) |
            | identity        | IL      |         |
            | flags           | 1       | ``      |
          schema:
            type: object
            required:
              - req-id
              - len
              - opcode
              - segment-key-len
              - segment-key
              - identity-len
              - flags
            properties:
              req-id:
                type: number
                description: |
                  Request ID: a connection specific unique identifier of the request/responses.  Has no meaning beyond connection.
              len:
                type: number
                description: |
                  Length in bytes constituting the remainder of this message: number of bytes that follow this *len*.
              opcode:                  
                type: bytes
                description: |
                  Operation code.
              segment-key-len:
                type: number
                description: |
                  Length in bytes of *segment-key*.
              segment-key:
                type: bytes
                description: |
                  See [glossary](glossary.html#segment-key).
              identity-len:
                type: number
                description: |
                  Length in bytes of [identity](glossary.html#identity).
              identity:
                type: bytes
                description: |
                  Optional identity.  If provided, qualifies the [datastore-key](glossary.html#datastore-key) owner--complementary to delegation.  
                  
                  May be one of public identities:  0 .. 9999.  
                  
                  If not provided, [authorized identity](#security-definition-Authorization%20WSS) defaults as owner.

                  See [glossary](glossary.html#identity).
              flags:
                type: bytes
                description: |
                  A byte of flags.  

                  | *value* | *name* | *description* |
                  | --- | --- | --- |
                  | 0x01 | shunt | `0`: subscription doesn't send actual message content, just notification of new messages with a new *unixtime-millis*.  `1`: full message content is sent via subscription. |
                  | 0x02 | auto-acknowledge | `0`: explicit acknowledgment via [acknowledge](#operation-acknowledge-messages-WIRE) call required.  `1`: messages are auto-acknowledged, not queued.  This falg only applies in conjunction with the *shunt* flag |  
                  | 0x04 | wait-until-persisted | `1`: wait until datastore-key changes are persisted (only relevant if *auto-acknowledge* is `1`) |
                  | 0x08 | wait-until-shared | `1`: wait until datastore-key changes are shared on distributed persistence network (only relevant if *auto-acknowledge* is `1`) |                  
      consumes:
        - application/octet-stream
      produces:
        - application/octet-stream
      security:
        - Authorization WSS: []
      responses:
        RESPONSE:
          $ref: "#/responses/WIRE"
        code == 222:
          description: |
            For as long as the connection remains opened, all [datastore-keys](glossary.html#datastore-key)--subscribed to using this *subscribe* request--may emit 222 responses.

            Each 222 event requires a subsequent [acknowledgment](#operation-acknowledge-WIRE) by the client.

            The following details the possible messages that will come across.

            An example event stream coming across the Web socket for a *non-shunt* subscription:

            | *syntax*          | *bytes* | *value* |
            | ---               | ---     | ---     |
            | loop {            |         |         |
            |   unixtime-millis | 8       |         |
            | }                 |         | ``      |

            The events stream are just *unixtime-millis*s, indicating messages are present to be retrieved via [the getter](#operation-fetch-messages-WIRE).

            An example event stream coming across the Web scoket for a *shunt* subscription:

            | *syntax*          | *bytes* | *value* |
            | ---               | ---     | ---     |
            | flags             | 1       |         |
            | loop {            |         |         |
            |   unixtime-millis | 8       |         |
            |   message-len     | 8       | ML = length(message) + 1 |
            |   message         | *       |         |
            | }                 |         | ``      |

          schema:
            type: object
            required:
              - flags
              - unixtime-millis
              - message-len
              - message
            properties:
              flags:
                type: bytes
                description: |
                  A byte of flags.  

                  The `0x80` (done) flag--if `1`--indicates that all messages in the descriptor loop are done; do not have fragment bytes outstanding.  A `0` value indicates that the last message in the descriptor loop is fragmented and bytes are still outstanding.  Those bytes will come down in the imediatelly following 222 subscription events.  The *unixtime-millis* will be repeated for all fragments.  The aggregate fragments are all transmitted for the message if the `0x80` (done) flag comes down as a `1` or the fragmented message is not the last message in the descriptor loop.

                  | *value* | *name* | *description* |
                  | ---  | ---  | --- |
                  | 0x80 | done | `1`: all the messages in the descriptor loop are done--do not have outstanding fragments--`0`: the last message in the descriptor loop has additional fragments, to come down in the imediatelly following 222 subscription events |
              unixtime-millis:
                type: number
                description: |
                  Non-unique UNIX Epoch timestamp (milliseconds) of the message.        
              message-len:
                type: number
                description: |
                  Length in bytes of *message*.
              message:
                type: bytes
                description: |
                  The message byte stream value.
        code == 400:
          $ref: "#/responses/400"
        code == 404:
          $ref: "#/responses/404-datastore-key"

  set delegate data:
    options:
      summary: A delegate sets their specific value under this datastore-key.
      description: |
        Payload contents is written as a new value into [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)) qualified by the caller's [identity](glossary.html#identity).  
        
        This call requires two identities:  the [segment-key](glossary.html#segment-key) and [identity](glossary.html#identity) request parameters constitute the [datastore-key](glossary.html#datastore-key).  The [identity](glossary.html#identity) from the [authorization header](#security-definition-Authorization Header)
        is used to qualify the data stored at the [segment-key](glossary.html#segment-key): this [identity](glossary.html#identity) is the delegate.

        For the *set* to succeed the [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)) must exist and be owned by the [identity](glossary.html#identity)
        from the request parameter.

        A delegate can only write their value to this [segment-key](glossary.html#segment-key) [settings on *segment-key* permitting](#definition-DatastoreKeySettings).  Only the delegate identified can write data.  The *settings* are solely to identify who the delegates can be.

        If this broker is not an [(pour) active steward](#tag-data-stewardship) of data for [identity](glossary.html#identity), call fails with a 400 -- "cannot write, broker not an active steward of user's data"
      tags:
        - delegate
      parameters:
        - in: body
          name: payload
          description: |

            | *syntax*          | *bytes* | *value* |
            | ---               | ---     | ---     |
            | req-id            | 8       |         |
            | len               | 8       | SL + IL + length(payload) + 4 + [32] |
            | opcode            | 1       | 0x08    |
            | segment-key-len   | 1       | SL == length(segment-key) |
            | segment-key       | SL      |         |
            | identity-len      | 1       | IL == length(identity) |
            | identity          | IL      |         |
            | flags             | 1       | ``      |
            | if flags & 0x10 { |         |         |
            |   write-gate      | 32      |         |
            | }                 |         |         |
            | payload           | *       | ``      |
          schema:
            type: object
            required:
              - req-id
              - len
              - opcode
              - segment-key-len
              - segment-key
              - identity-len
              - identity
              - flags
              - payload
            properties:
              req-id:
                type: number
                description: |
                  Request ID: a connection specific unique identifier of the request/responses.  Has no meaning beyond connection.
              len:
                type: number
                description: |
                  Length in bytes constituting the remainder of this message: number of bytes that follow this *len*.  32 bytes are added for a *write-gate* if *flags* has `0x10` set.
              opcode:                  
                type: bytes
                description: |
                  Operation code.
              segment-key-len:
                type: number
                description: |
                  Length in bytes of *segment-key*.
              segment-key:
                type: bytes
                description: |
                  See [glossary](glossary.html#segment-key).
              identity-len:
                type: number
                description: |
                  Length in bytes of [identity](glossary.html#identity).
              identity:
                type: bytes
                description: |
                  Required identity of *segment-key* owner--[authorization header](#security-definition-Authorization Header) [identity](glossary.html#identity) is used for qualifying the delegate.

                  See [glossary](glossary.html#identity).
              flags:
                type: bytes
                description: |
                  A byte of flags.  

                  | *value* | *name* | *description* |
                  | --- | --- | --- |
                  | 0x04 | wait-until-persisted | `1`: wait until datastore-key changes are persisted |
                  | 0x08 | wait-until-shared | `1`: wait until datastore-key changes are shared on distributed persistence network |                  
                  | 0x10 | gate-the-write | `1`: use SHA256 in *write-gate* to check value at *segment-key* for equality before overriding. |
                  | 0x80 | done | `1`: this payload is not fragmented; `0`: this payload is a fragment and subsequent [continue](#operation-continue-WIRE) messages will follow after the broker responds with a *200*. |
              write-gate:
                type: bytes
                description: |
                  Optional write "gate": a 32 byte SHA256 hash value of the content being replaced by this set operation.  If this hash does not match the current value at this *segment-key*, this
                  set operation will fail with error code 409.
              payload:
                type: bytes
                description: |
                  The payload byte-stream.
      consumes:
        - application/octet-stream
      produces:
        - application/octet-stream
      security:
        - Authorization WSS: []
      responses:
        RESPONSE:
          $ref: "#/responses/WIRE"
        code == 200:
          description: |
            Value successfully set.
        code == 400:
          $ref: "#/responses/400"
        code == 403:
          $ref: "#/responses/403"
        code == 409:
          $ref: "#/responses/409"
        code == 429:
          $ref: "#/responses/429"
  get delegate data:
    options:
      summary: A delegate retrieves their specific value under this datastore-key.
      description: |  
        Retrieve contents from [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)) qualified by the caller's [identity](glossary.html#identity).  

        This call requires two identities:  the [segment-key](glossary.html#segment-key) and [identity](glossary.html#identity) request parameters constitute the [datastore-key](glossary.html#datastore-key).  The [identity](glossary.html#identity) from the [authorization header](#security-definition-Authorization Header)
        is used to qualify the data stored at the [segment-key](glossary.html#segment-key): this [identity](glossary.html#identity) is the delegate.        
      tags:
        - delegate
      parameters:
        - in: body
          name: payload
          description: |

            | *syntax*        | *bytes* | *value* |
            | ---             | ---     | ---     |
            | req-id          | 8       |         |
            | len             | 8       | SL + IL + 3 |
            | opcode          | 1       | 0x09    |
            | segment-key-len | 1       | SL == length(segment-key) |
            | segment-key     | SL      |         |
            | identity-len    | 1       | IL == length(identity) |
            | identity        | IL      | ``      |
          schema:
            type: object
            required:
              - req-id
              - len
              - opcode
              - segment-key-len
              - segment-key
              - identity-len
              - identity
            properties:
              req-id:
                type: number
                description: |
                  Request ID: a connection specific unique identifier of the request/responses.  Has no meaning beyond connection.
              len:
                type: number
                description: |
                  Length in bytes constituting the remainder of this message: number of bytes that follow this *len*.
              opcode:                  
                type: bytes
                description: |
                  Operation code.
              segment-key-len:
                type: number
                description: |
                  Length in bytes of *segment-key*.
              segment-key:
                type: bytes
                description: |
                  See [glossary](glossary.html#segment-key).
              identity-len:
                type: number
                description: |
                  Length in bytes of [identity](glossary.html#identity).
              identity:
                type: bytes
                description: |
                  Required identity of *segment-key* owner--[authorization header](#security-definition-Authorization Header) [identity](glossary.html#identity) is used for qualifying the delegate.

                  See [glossary](glossary.html#identity).
      consumes:
        - application/octet-stream
      produces:
        - application/octet-stream
      security:
        - Authorization WSS: []
      responses:
        RESPONSE:
          $ref: "#/responses/WIRE"
        code == 200:
          description: |
            The value of [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)).
        code == 206:
          $ref: "#/responses/206"
        code == 246:
          $ref: "#/responses/246"
        code == 400:
          $ref: "#/responses/400"
        code == 403:
          $ref: "#/responses/403"
        code == 404:
          $ref: "#/responses/404-datastore-key"
        code == 422:
          $ref: "#/responses/422"
        code == 429:
          $ref: "#/responses/429"
  delete delegate data:
    options:
      summary: A delegate deletes their specific data under this datastore-key.
      description: |
        Delete delegate's data filed under the [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)).  

        This call requires two identities:  the [segment-key](glossary.html#segment-key) and [identity](glossary.html#identity) request parameters constitute 
        the [datastore-key](glossary.html#datastore-key).  The [identity](glossary.html#identity) from the [authorization header](#security-definition-Authorization Header)
        is used to qualify the data stored at the [segment-key](glossary.html#segment-key): this [identity](glossary.html#identity) is the delegate.

        The [datastore-key](glossary.html#datastore-key) must be owned by the [identity](glossary.html#identity) from request parameter.

        If this broker is not an [(pour) active steward](#tag-data-stewardship) of data for [identity](glossary.html#identity), call fails with a 400 -- "cannot write, broker not an active steward of user's data"
      tags:
        - delegate
      parameters:
        - in: body
          name: payload
          description: |

            | *syntax*        | *bytes* | *value* |
            | ---             | ---     | ---     |
            | req-id          | 8       |         |
            | len             | 8       | SL + IL + 4 |
            | opcode          | 1       | 0x0A    |
            | segment-key-len | 1       | SL == length(segment-key) |
            | segment-key     | SL      |         |
            | identity-len    | 1       | IL == length(identity) |
            | identity        | IL      | ``      |
            | flags           | 1       | ``      |
          schema:
            type: object
            required:
              - req-id
              - len
              - opcode
              - segment-key-len
              - segment-key
              - identity-len
              - identity
              - flags
            properties:
              req-id:
                type: number
                description: |
                  Request ID: a connection specific unique identifier of the request/responses.  Has no meaning beyond connection.
              len:
                type: number
                description: |
                  Length in bytes constituting the remainder of this message: number of bytes that follow this *len*.
              opcode:                  
                type: bytes
                description: |
                  Operation code.
              segment-key-len:
                type: number
                description: |
                  Length in bytes of *segment-key*.
              segment-key:
                type: bytes
                description: |
                  See [glossary](glossary.html#segment-key).
              identity-len:
                type: number
                description: |
                  Length in bytes of [identity](glossary.html#identity).
              identity:
                type: bytes
                description: |
                  Required identity of *segment-key* owner--[authorization header](#security-definition-Authorization Header) [identity](glossary.html#identity) is used for qualifying the delegate.

                  See [glossary](glossary.html#identity).
              flags:
                type: bytes
                description: |
                  A byte of flags.  

                  | *value* | *name* | *description* |
                  | --- | --- | --- |
                  | 0x04 | wait-until-persisted | `1`: wait until datastore-key changes are persisted |
                  | 0x08 | wait-until-shared | `1`: wait until datastore-key changes are shared on distributed persistence network |                  
      consumes:
        - application/octet-stream
      produces:
        - application/octet-stream
      security:
        - Authorization WSS: []
      responses:
        RESPONSE:
          $ref: "#/responses/WIRE"
        code == 200:
          description: |
            Success.  Empty.
        code == 400:
          $ref: "#/responses/400"
        code == 403:
          $ref: "#/responses/403"
        code == 404:
          $ref: "#/responses/404-datastore-key"
        code == 429:
          $ref: "#/responses/429"
  
  get all delegate values:
    options:
      summary: Retrieves all delegate data under segment-key as map of delegate identities to content.
      description: |
        Retrieve all delegate data under [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)) as map of delegate
        identities to content.

        The [segment-key](glossary.html#segment-key) and [identity](glossary.html#identity) request parameters constitute the [datastore-key](glossary.html#datastore-key).
      tags:
        - delegate
      parameters:
        - in: body
          name: payload
          description: |

            | *syntax*        | *bytes* | *value* |
            | ---             | ---     | ---     |
            | req-id          | 8       |         |
            | len             | 8       | SL + IL + 3 |
            | opcode          | 1       | 0x0B    |
            | segment-key-len | 1       | SL == length(segment-key) |
            | segment-key     | SL      |         |
            | identity-len    | 1       | IL == length(identity) |
            | identity        | IL      |         |
          schema:
            type: object
            required:
              - req-id
              - len
              - opcode
              - segment-key-len
              - segment-key
              - identity-len
              - identity
            properties:
              req-id:
                type: number
                description: |
                  Request ID: a connection specific unique identifier of the request/responses.  Has no meaning beyond connection.
              len:
                type: number
                description: |
                  Length in bytes constituting the remainder of this message: number of bytes that follow this *len*.
              opcode:                  
                type: bytes
                description: |
                  Operation code.
              segment-key-len:
                type: number
                description: |
                  Length in bytes of *segment-key*.
              segment-key:
                type: bytes
                description: |
                  See [glossary](glossary.html#segment-key).
              identity-len:
                type: number
                description: |
                  Length in bytes of [identity](glossary.html#identity).
              identity:
                type: bytes
                description: |
                  Required identity of *segment-key* owner.

                  See [glossary](glossary.html#identity).
      consumes:
        - application/octet-stream
      produces:
        - application/octet-stream
      security:
        - Authorization WSS: []
      responses:
        RESPONSE:
          $ref: "#/responses/WIRE"
        code == 200:
          description: |
            List of all delegate data under the [datastore-key](glossary.html#datastore-key).

            | *syntax*        | *bytes* | *value* |
            | ---             | ---     | ---     |
            | loop {          |         |         |
            |   delegate-len  | 1       | DL == length(delegate) |
            |   delegate      | DL      |         |
            |   message-len   | 8       | ML = length(message) |
            |   message       | *       |         |
            | }               |         | ``      |

          schema:
            type: object
            required:
              - delegate-len
              - delegate
              - message-len
              - message
            properties:
              delegate-len:
                type: number
                description: |
                  Length in bytes of *delegate*.
              delegate:
                type: bytes
                description: |
                  Qualifies which [delegate](#tag-delegate) of [segment-key](glossary.html#segment-key) this message corresponds to.  The value is the delegate's [identity](glossary.html#identity).
              message-len:
                type: number
                description: |
                  Length in bytes of *message*.
              message:
                type: bytes
                description: |
                  The message byte stream value.
        code == 206:
          $ref: "#/responses/206"
        code == 246:
          $ref: "#/responses/246"
        code == 400:
          $ref: "#/responses/400"
        code == 403:
          $ref: "#/responses/403"
        code == 404:
          $ref: "#/responses/404-datastore-key"
        code == 422:
          $ref: "#/responses/422"
        code == 429:
          $ref: "#/responses/429"
  /{segment-key}/settings:
    put:
      summary: Setup settings for given datastore-key ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)).
      description: |
        Setup data and backchannel settings for given [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)).

        If this broker is not an [(pour) active steward](#tag-data-stewardship) of data for [identity](glossary.html#identity), call fails with a 400 -- "cannot write, broker not an active steward of user's data"
      tags:
        - datastore-key settings
      parameters:
        - in: body
          name: datastore-value
          schema:
            $ref: "#/definitions/DatastoreKeySettings"
        - in: path
          name: segment-key
          required: true
          description: |
            Base64 encoded [segment-key](glossary.html#segment-key).
          type: string
        - in: query
          name: identity
          required: false
          description: |
            Optional identity.  If provided, must be one of public restricted identities:  0 .. 9999.  If not provided, identity is that of token owner.

            See [glossary](glossary.html#identity).
          type: string
        - in: query
          name: wait-until-persisted
          required: false
          description: |
            Optional request to synchronously block result until change to [datastore-key](glossary.html#datastore-key) is persisted.
          type: boolean
        - in: query
          name: wait-until-shared
          required: false
          description: |
            Optional request to synchronously block result until change to [datastore-key](glossary.html#datastore-key) is shared on distributed persistence network.
          type: boolean
      security:
        - Authorization Header: []
      consumes:
        - application/json
      responses:
        200:
          description: |
            Settings applied successfully.
        400:
          $ref: "#/responses/400"
        403:
          $ref: "#/responses/403"
        404:
          $ref: "#/responses/404-datastore-key"
        429:
          $ref: "#/responses/429"
    get:
      summary: Returns settings for a given datastore-key.
      description: |
        Returns data and backchannel settings for a given [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)).
      tags:
        - datastore-key settings
      parameters:
        - in: path
          name: segment-key
          required: true
          description: |
            See [glossary](glossary.html#segment-key).
          type: string
        - in: query
          name: identity
          required: false
          description: |
            Optional identity.  If provided, must be one of public restricted identities:  0 .. 9999.  If not provided, identity is that of token owner.

            See [glossary](glossary.html#identity).
          type: string
      security:
        - Authorization Header: []
      produces:
        - application/json
      responses:
        200:
          description: |
            The value of [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)).
          schema:
            $ref: "#/definitions/DatastoreKeySettings"
        246:
          $ref: "#/responses/246"
        400:
          $ref: "#/responses/400"
        403:
          $ref: "#/responses/403"
        404:
          $ref: "#/responses/404-datastore-key"
        422:
          $ref: "#/responses/422"
        429:
          $ref: "#/responses/429"
  /metrics:
    get:
      summary: Returns metrics for all datastore-keys owned by an identity.
      description: |
        Returns overall metrics for all [datastore-keys](glossary.html#datastore-key) ([segment-keys](glossary.html#segment-key) @ [identity](glossary.html#identity)) owned by an *identitiy*.
      tags:
        - metrics
      security:
        - Authorization Header: []
      produces:
        - application/json
      responses:
        200:
          description: |
            Metrics for all [datastore-keys](glossary.html#datastore-key) ([segment-keys](glossary.html#segment-key) @ [identity](glossary.html#identity)) of the user.
          schema:
            $ref: "#/definitions/Metrics"
        246:
          $ref: "#/responses/246"
        400:
          $ref: "#/responses/400"
        403:
          $ref: "#/responses/403"
        404:
          $ref: "#/responses/404-datastore-key"
        422:
          $ref: "#/responses/422"
        429:
          $ref: "#/responses/429"
  /{segment-key}/metrics:
    get:
      summary: Returns metrics for a given datastore-key.
      description: |
        Returns data and backchannel metrics for a given [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)).
      tags:
        - metrics
      parameters:
        - in: path
          name: segment-key
          required: true
          description: |
            Base64 encoded [segment-key](glossary.html#segment-key).
          type: string
        - in: query
          name: identity
          required: false
          description: |
            Optional identity.  If provided, must be one of public restricted identities:  0 .. 9999.  If not provided, identity is that of token owner.

            See [glossary](glossary.html#identity).
          type: string
      security:
        - Authorization Header: []
      produces:
        - application/json
      responses:
        200:
          description: |
            Metrics for this [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)).
          schema:
            $ref: "#/definitions/Metrics"
        246:
          $ref: "#/responses/246"
        400:
          $ref: "#/responses/400"
        403:
          $ref: "#/responses/403"
        404:
          $ref: "#/responses/404-datastore-key"
        422:
          $ref: "#/responses/422"
        429:
          $ref: "#/responses/429"
  segment-keys:
    options:
      summary: Retrieve key-names of all segment-keys owned by an indentity.
      description: |
        Retrieve key-names of all [segment-keys](glossary.html#segment-key) owned by an indentity.
      tags:
        - metrics
      parameters:
        - in: body
          name: payload
          description: |

            | *syntax*        | *bytes* | *value* |
            | ---             | ---     | ---     |
            | req-id          | 8       |         |
            | len             | 8       | IL + 1  |
            | opcode          | 1       | 0x0F    |
          schema:
            type: object
            required:
              - req-id
              - len
              - opcode
            properties:
              req-id:
                type: number
                description: |
                  Request ID: a connection specific unique identifier of the request/responses.  Has no meaning beyond connection.
              len:
                type: number
                description: |
                  Length in bytes constituting the remainder of this message: number of bytes that follow this *len*.
              opcode:                  
                type: bytes
                description: |
                  Operation code.
      consumes:
        - application/octet-stream
      produces:
        - application/octet-stream
      security:
        - Authorization WSS: []
      responses:
        RESPONSE:
          $ref: "#/responses/WIRE"
        code == 200:
          description: |
            Key-names of [segment-keys](glossary.html#segment-key) in a loop.

            | *syntax*        | *bytes* | *value* |
            | ---             | ---     | ---     |
            | loop {          |         |         |
            |   key-name      | 128     |         |
            | }               |         | ``      |                        
        code == 206:
          $ref: "#/responses/206"
        code == 400:
          $ref: "#/responses/400"
        code == 403:
          $ref: "#/responses/403"
        code == 429:
          $ref: "#/responses/429"

  import:
    options:
      summary: Indiscriminately Set all user's data on the broker system.
      description: |
        All of the user's data with caller's [identity](glossary.html#identity) is wiped and reset to the payload.

        > When filling broker in [pour-active-steward](#operation--pour-active-stewardship-put) mode don't use this *import*--as it's indiscriminate--use [*fill*](#operation-fill-WIRE) instead.

        If transferring a [segment-key](glossary.html#segment-key) with a public restricted identity (0 .. 9999), if the
        [segment-key](glossary.html#segment-key) already exists at provided identity for a different *owner*, the message
        call fails with a 409 -- "datastore-key ownership conflict; [segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity) already reserved".

        If the payload is malformated and cannot be imported the message call fails with a 
        400 -- "cannot process input", followed by additional optional verbiage.

        If this broker is not an [(pour) active steward](#tag-data-stewardship) of data for [identity](glossary.html#identity), call fails with a 400 -- "cannot write, broker not an active steward of user's data"
      tags:
        - data-stewardship
      parameters:
        - in: body
          name: payload
          description: |

            | *syntax*        | *bytes* | *value* |
            | ---             | ---     | ---     |
            | req-id          | 8       |         |
            | len             | 8       | SL + IL + length(payload) + 4 |
            | opcode          | 1       | 0x0C    |
            | flags           | 1       |         |
            | payload         | *       | ``      |

          schema:
            type: object
            required:
              - req-id
              - len
              - opcode
              - flags
              - payload
            properties:
              req-id:
                type: number
                description: |
                  Request ID: a connection specific unique identifier of the request/responses.  Has no meaning beyond connection.
              len:
                type: number
                description: |
                  Length in bytes constituting the remainder of this message: number of bytes that follow this *len*.
              opcode:                  
                type: bytes
                description: |
                  Operation code.
              flags:
                type: bytes
                description: |
                  A byte of flags.  

                  | *value* | *name* | *description* |
                  | --- | --- | --- |
                  | 0x04 | wait-until-persisted | `1`: wait until datastore-key changes are persisted |
                  | 0x08 | wait-until-shared | `1`: wait until datastore-key changes are shared on distributed persistence network |
                  | 0x80 | done | `1`: this payload is not fragmented; `0`: this payload is a fragment and subsequent [continue](#operation-continue-WIRE) messages will follow after the broker responds with a *200*. |
              payload:
                description: |
                  All data in JSON format with UTF-8 encoding.
                
                  *Payload* adheres to the [ImportExportPayload definition](#/definitions/ImportExportPayload).
      consumes:
        - application/octet-stream
      produces:
        - application/octet-stream
      security:
        - Authorization WSS: []
      responses:
        RESPONSE:
          $ref: "#/responses/WIRE"
        code == 200:
          description: |
            Success.  Empty.
        code == 400:
          $ref: "#/responses/400"
        code == 403:
          $ref: "#/responses/403"
        code == 429:
          $ref: "#/responses/429"
  fill:
    options:
      summary: Discriminately set all user's data on the broker system.
      description: |
        All of the user's data with caller's [identity](glossary.html#identity) that is deemed older than the payload is wiped and reset to the payload.

        If transferring a [segment-key](glossary.html#segment-key) that already exists on the broker for caller's [identity](glossary.html#identity), the [segment-key](glossary.html#segment-key) in the payload is ignored.

        If transferring a [segment-key](glossary.html#segment-key) with a public restricted identity (0 .. 9999), if the
        [segment-key](glossary.html#segment-key) already exists at provided identity for a different *owner*, the message
        call fails with a 409 -- "datastore-key ownership conflict; [segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity) already reserved".

        If the payload is malformated and cannot be imported the message call fails with a 
        400 -- "cannot process input", followed by additional optional verbiage.

        If this broker is not a [(pour) active steward](#tag-data-stewardship) of data for [identity](glossary.html#identity), call fails with a 400 -- "cannot write, broker not an active steward of user's data"
      tags:
        - data-stewardship
      parameters:
        - in: body
          name: payload
          description: |

            | *syntax*        | *bytes* | *value* |
            | ---             | ---     | ---     |
            | req-id          | 8       |         |
            | len             | 8       | SL + IL + length(payload) + 4 |
            | opcode          | 1       | 0x0D    |
            | flags           | 1       |         |
            | payload         | *       | ``      |

          schema:
            type: object
            required:
              - req-id
              - len
              - opcode
              - flags
              - payload
            properties:
              req-id:
                type: number
                description: |
                  Request ID: a connection specific unique identifier of the request/responses.  Has no meaning beyond connection.
              len:
                type: number
                description: |
                  Length in bytes constituting the remainder of this message: number of bytes that follow this *len*.
              opcode:                  
                type: bytes
                description: |
                  Operation code.
              flags:
                type: bytes
                description: |
                  A byte of flags.  

                  | *value* | *name* | *description* |
                  | --- | --- | --- |
                  | 0x04 | wait-until-persisted | `1`: wait until datastore-key changes are persisted |
                  | 0x08 | wait-until-shared | `1`: wait until datastore-key changes are shared on distributed persistence network |
                  | 0x80 | done | `1`: this payload is not fragmented; `0`: this payload is a fragment and subsequent [continue](#operation-continue-WIRE) messages will follow after the broker responds with a *200*. |
              payload:
                description: |
                  All data in JSON format with UTF-8 encoding.
                
                  *Payload* adheres to the [ImportExportPayload definition](#/definitions/ImportExportPayload).
      consumes:
        - application/octet-stream
      produces:
        - application/octet-stream
      security:
        - Authorization WSS: []
      responses:
        RESPONSE:
          $ref: "#/responses/WIRE"
        code == 200:
          description: |
            Success.  Empty.
        code == 400:
          $ref: "#/responses/400"
        code == 403:
          $ref: "#/responses/403"
        code == 429:
          $ref: "#/responses/429"
  export:
    options:
      summary: Extract all user's data from the broker system.
      description: |
        Extract all of the caller's data, based on caller's [identity](glossary.html#identity).
      tags:
        - data-stewardship
      parameters:
        - in: body
          name: payload
          description: |

            | *syntax*        | *bytes* | *value* |
            | ---             | ---     | ---     |
            | req-id          | 8       |         |
            | len             | 8       | SL + IL + 3 |
            | opcode          | 1       | 0x0E    |
          schema:
            type: object
            required:
              - req-id
              - len
              - opcode
            properties:
              req-id:
                type: number
                description: |
                  Request ID: a connection specific unique identifier of the request/responses.  Has no meaning beyond connection.
              len:
                type: number
                description: |
                  Length in bytes constituting the remainder of this message: number of bytes that follow this *len*.
              opcode:                  
                type: bytes
                description: |
                  Operation code.
      consumes:
        - application/octet-stream
      produces:
        - application/octet-stream
      security:
        - Authorization WSS: []
      responses:
        RESPONSE:
          $ref: "#/responses/WIRE"
        code == 200:
          description: |
            All data in JSON format with UTF-8 encoding.
          schema:
            $ref: "#/definitions/ImportExportPayload"
        code == 206:
          $ref: "#/responses/206"
        400:
          $ref: "#/responses/400"
        403:
          $ref: "#/responses/403"
        429:
          $ref: "#/responses/429"              
  /opt-in-data/{type-key}/{guid}:
    post:
      summary: Set all user's opt-in data from a connected persistence network.
      description: |
        For all [segment-key](glossary.html#segment-key) available on the decentralized persistence, data in this broker's  [segment-key](glossary.html#segment-key) is wiped and reset to data available at the same [identity](glossary.html#identity) on the specificed persistence network.  The network data is identified by the provided *GUID*.  The broker must be able to exchange data on the network that's identified by *type-key*.

        This message can only be called on a [passive or pour-active steward](#tag-data-stewardship).  Calling this message on an [active steward](#tag-data-stewardship) will result in error code 400 -- "cannot continue, invalid stewardship mode".

        Note that the only [segment-key](glossary.html#segment-key) imported are ones explicitly opted-in on some [active steward](glossary.html#data-steward) (other than this steward) with either the [opt-in endpoint](#operation--auth-opt-in--agree--put) or the [*segment-key* specific opt-in](#definition-DatastoreKeySettings).

        This setter works in conjunction with the [*GUIDs* getter](#operation--guids-get), which is to be called against the source broker instance.  The source broker is a broker currently furnishing the data to the network.

        If transferring a [segment-key](glossary.html#segment-key) with a public restricted identity (0 .. 9999), if the
        [segment-key](glossary.html#segment-key) already exists at provided identity for a different *owner*, the message
        call fails with a 409 -- "datastore-key ownership conflict; [segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity) already reserved".

        If the *type-key* requested is not supported by this broker system the message call fails with
        a 400 -- "invalid type-key, doesn't match broker system capabilities".

        If data from the remote *GUID* cannot be extracted or in otherwise unavailable the message call fails with a 
        502 -- "cannot reach data".

        If the payload from the other broker is malformated and cannot be imported the message call fails 
        with a 400 -- "cannot process input", followed by additional optional verbiage.
      tags:
        - data-stewardship
      parameters:
        - in: path
          name: type-key
          required: true
          description: |
            A *type-key* as per [enumertion](#definition-GUID).
          type: string
        - in: path
          name: guid
          required: true
          description: |
            A *GUID* on the *type-key* network of the source of import data.  Retrieve this using
            [*GUIDs* getter](#operation--guids-get) on the exporting broker instance.
          type: string
      security:
        - Authorization Header: []
      consumes:
        - application/json
      responses:
        200:
          description: |
            Data successfully set.
        400:
          $ref: "#/responses/400"
        403:
          $ref: "#/responses/403"
        429:
          $ref: "#/responses/429"
        502:
          $ref: "#/responses/502"
    delete:
      summary: Delete all user's data on the broker system.
      description: |
        Delete all user's data on the broker system, based on [identity](glossary.html#identity) passed in.
      tags:
        - data-stewardship
      parameters:
        - in: query
          name: wait-until-persisted
          required: false
          description: |
            Optional request to synchronously block result until change to [datastore-key](glossary.html#datastore-key) is persisted.
          type: boolean
        - in: query
          name: wait-until-shared
          required: false
          description: |
            Optional request to synchronously block result until change to [datastore-key](glossary.html#datastore-key) is shared on distributed persistence network.
          type: boolean
      security:
        - Authorization Header: []
      responses:
        200:
          description: |
            If all data is deleted.
        400:
          $ref: "#/responses/400"
        403:
          $ref: "#/responses/403"
        429:
          $ref: "#/responses/429"
  /active-stewardship:
    put:
      summary: Make this broker an active-steward of the user's data.
      description: |
        All of the user's data with caller's [identity](glossary.html#identity) is now under this broker's [active-stewardship](glossary.html#data-steward).

        Once activated, the user can write data to their [datastore-keys](glossary.html#datastore-key).

        Stops pulling updates *from* decentralized storage and starts pushing updates *to* decentralized storage.

        This call is idempotent: call this to change from [pour-active-stewardship](#operation--pour-active-stewardship-put).

        WARNING: having more than one "active" data-steward may lead to write race-conditions on the distributed persistence network with unknown consequences.
      parameters:
        - in: body
          name: activation
          description: |
            Activation parameters.
          schema:
            type: object
            properties:
              broker-address-signed:
                type: string
                description: |
                  BASE64 encoded.

                  This parameter can only be provided if *unixtime-millis* and *unixtime-millis-signed* are also provided.

                  The [broker-address](glossary.html#broker-address) on the reumneration-provider matching caller's [identity](glossary.html#identity)--as provided by [/capabilities/address](#operation--capabilities-address-get)--signed with the private key corrsponding to the [user-address](glossary.html#user-address) of [identity](glossary.html#identity).

                  Signature algorithm is [remuneration-key](#/definitions/RemunerationKey) specific; for Ethereum it's *keccak-256*, for Bitcoin it's *secp256k1*.  Refer to the ledger's remuneration API.

                  Providing this parameter signals we want to advertise this broker as the caller's [user-address](glossary.html#user-address)' [activeHost](glossary.html#data-steward) to the [lookup network](#tag-broker-lookup) corresponding to the [remuneration-key](#/definitions/RemunerationKey) used for this [identity](glossary.html#identity).

                  If the [lookup network](#tag-broker-lookup) currently has a [drain-host](glossary.html#drain-host) entry, the [drain-host](glossary.html#drain-host) entry is removed from the [lookup network](#tag-broker-lookup).
              unixtime-millis:
                type: number
                description: |
                  Non-unique UNIX Epoch timestamp (milliseconds) that must be within 300000 milliseconds of the current system time of the broker.  This gives the caller five minutes of tolerance either in the future or in the past.  You can use [/capabilities/unixtime-millis](#operation--capabilities-unixtime-millis-get) as the source for this parameter.

                  If this parameter is provided, *unixtime-millis-signed* must be provided as well.

                  These parameters mitigate replay attacks.
              unixtime-millis-signed:
                type: string
                description: |
                  BASE64 encoded.

                  The *unixtime-millis* provided above signed with the private key corrsponding to the [user-address](glossary.html#user-address) of [identity](glossary.html#identity).

                  Signature algorithm is [remuneration-key](#/definitions/RemunerationKey) specific; for Ethereum it's *keccak-256*, for Bitcoin it's *secp256k1*.  Refer to the ledger's remuneration API.
      tags:
        - data-stewardship
      security:
        - Authorization Header: []
      consumes:
        - application/json
      responses:
        200:
          description: |
            Stewardship status change successful.
        400:
          $ref: "#/responses/400"
        403:
          $ref: "#/responses/403"
        429:
          $ref: "#/responses/429"
    delete:
      summary: Make this broker a passive-steward of the user's data
      description: |
        All of the user's data with caller's [identity](glossary.html#identity) is now under this broker's [passive-stewardship](glossary.html#data-steward).

        Data--as available on the distributed persistence network--will be pinned/hosted by this broker.  It will be eventually consistent with 
        data as written to an [active-steward](glossary.html#data-steward) on the network.

        Data writes are prohibited to passive-stewards.
      tags:
        - data-stewardship
      security:
        - Authorization Header: []
      responses:
        200:
          description: |
            Stewardship status change successful.
        400:
          $ref: "#/responses/400"
        403:
          $ref: "#/responses/403"
        429:
          $ref: "#/responses/429"
  /pour-active-stewardship:
    put:
      summary: Put this broker into active-steward mode for data migration.
      description: |
        All of the user's data with caller's [identity](glossary.html#identity) is now under this broker's [active-stewardship](glossary.html#data-steward) with caveats:

        * *getter methods* will return [246/Inconclusive](#/responses/246) on successful reads of [segment-key](glossary.html#segment-key) that weren't explicitly written to: see [response status code *246*](#/responses/246).  This is important for continuity of data-access during migrations:
            1. finishing up any persistence storage network synchronization from a previously [active-steward](glossary.html#data-steward) before making this broker a [regular active-steward](#operation--active-stewardship-put).  See [data-stewardship](#tag-data-stewardship) for use-cases.
            1. allowing for time-consuming explicit export from a previously [active-steward](glossary.html#data-steward) and explicit [fill](#operation-fill-WIRE) of this broker; before making this broker a [regular active-steward](#operation--active-stewardship-put).  See [data-stewardship](#tag-data-stewardship) for use-cases.
        * accepts decentralized storage data changes until an explicit API write to a [segment-key](glossary.html#segment-key):
            * overwrites data in that [segment-key](glossary.html#segment-key) as usual (see [response code *246](#/responses/246))
            * causes the [segment-key](glossary.html#segment-key) to stops being overwritten by decentralized storage changes
            * causes the [segment-key](glossary.html#segment-key) to start returning 200/OK on *getter methods* instead of [246/Inconclusive](#/responses/246)
        
        Once activated, the user can write data to their [datastore-keys](glossary.html#datastore-key).

        Ensures updates *from* decentralized storage continue to be pulled; does not push updates *to* decentralized storage.

        This call is idempotent: call this to change from [passive or active stewardship](#tag-data-stewardship).

        Note that this *pour-active stewardship* mode is complementary with the [fill endpoint](#operation-fill-WIRE) when not leveraging distributed persistence.

        When in this *pour-active stewardship* mode--while waiting for persistence network to synchronize data from a [passive-steward](glossary.html#data-steward)--this *pour-active steward* can be safely transitioned to an [active steward](#operation--active-stewardship-put) once the [passive-steward](glossary.html#data-steward) and this broker both return the same identifier from [GET /latest-snapshot-id](#operation--latest-snapshot-id--guid--get).
        
        WARNING: having more than one "active" data-steward may lead to write race-conditions on the distributed persistence network with unknown consequences.
      parameters:
        - in: body
          name: activation
          description: |
            Activation parameters.
          schema:
            type: object
            properties:
              drain-host:
                type: string
                description: |
                  This parameter can only be provided if *drain-host-signed*, *unixtime-millis*, *unixtime-millis-signed*, and *broker-address-signed* are also provided.

                  This is the host name or IP address of the [passive-steward broker](glossary.html#data-steward) we're draining data from into this broker.  

                  This host name or IP address--if properly signed by *drain-host-signed*--will be pushed to the [lookup network](#tag-broker-lookup) corresponding to the [remuneration-key](#/definitions/RemunerationKey) used for this [identity](glossary.html#identity).

                  Once the [lookup network](#tag-broker-lookup) has this *drain-host* it can aid all data-access during a [migration](#tag-data-stewardship).
              drain-host-signed:
                type: string
                description: |
                  BASE64 encoded.

                  This parameter can only be provided if *drain-host*, *unixtime-millis*, *unixtime-millis-signed*, and *broker-address-signed* are also provided.

                  This is the *drain-host* (provided above) signed with the private key corrsponding to the [user-address](glossary.html#user-address) of [identity](glossary.html#identity).

                  Signature algorithm is [remuneration-key](#/definitions/RemunerationKey) specific; for Ethereum it's *keccak-256*, for Bitcoin it's *secp256k1*.  Refer to the ledger's remuneration API.
              broker-address-signed:
                type: string
                description: |
                  BASE64 encoded.

                  This parameter can only be provided if *unixtime-millis* and *unixtime-millis-signed* are also provided.

                  The [broker-address](glossary.html#broker-address) on the reumneration-provider matching caller's [identity](glossary.html#identity)--as provided by [/capabilities/address](#operation--capabilities-address-get)--signed with the private key corrsponding to the [user-address](glossary.html#user-address) of [identity](glossary.html#identity).

                  Signature algorithm is [remuneration-key](#/definitions/RemunerationKey) specific; for Ethereum it's *keccak-256*, for Bitcoin it's *secp256k1*.  Refer to the ledger's remuneration API.

                  Providing this parameter signals we want to advertise this broker as the caller's [user-address](glossary.html#user-address)' [activeHost](glossary.html#data-steward) to the [lookup network](#tag-broker-lookup) corresponding to the [remuneration-key](#/definitions/RemunerationKey) used for this [identity](glossary.html#identity).
              unixtime-millis:
                type: number
                description: |
                  Non-unique UNIX Epoch timestamp (milliseconds) that must be within 300000 milliseconds of the current system time of the broker.  This gives the caller five minutes of tolerance either in the future or in the past.  You can use [/capabilities/unixtime-millis](#operation--capabilities-unixtime-millis-get) as the source for this parameter.

                  If this parameter is provided, *unixtime-millis-signed* must be provided as well.

                  These parameters mitigate replay attacks.
              unixtime-millis-signed:
                type: string
                description: |
                  BASE64 encoded.

                  The *unixtime-millis* provided above signed with the private key corrsponding to the [user-address](glossary.html#user-address) of [identity](glossary.html#identity).

                  Signature algorithm is [remuneration-key](#/definitions/RemunerationKey) specific; for Ethereum it's *keccak-256*, for Bitcoin it's *secp256k1*.  Refer to the ledger's remuneration API.
      tags:
        - data-stewardship
      security:
        - Authorization Header: []
      consumes:
        - application/json
      responses:
        200:
          description: |
            Stewardship status change successful.
        400:
          $ref: "#/responses/400"
        403:
          $ref: "#/responses/403"
        429:
          $ref: "#/responses/429"
  /{segment-key}/persistence-status:
    get:
      summary: Retrieve content hashes at different memory levels.
      description: |
        Returns content-hashes representing latest content stored at each [memory level](glossary.html#working-memory-permanent-memory-shared-memory-persistence-status)
        for a given [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)).
      tags:
        - data-stewardship
      parameters:
        - in: path
          name: segment-key
          required: true
          description: |
            Base64 encoded [segment-key](glossary.html#segment-key).
          type: string
        - in: query
          name: identity
          required: false
          description: |
            Optional identity.  If provided, must be one of public restricted identities:  0 .. 9999.  If not provided, identity is that of token owner.

            See [glossary](glossary.html#identity).
          type: string
      security:
        - Authorization Header: []
      produces:
        - application/json
      responses:
        200:
          description: |
            The content-hashes for the [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)).
          schema:
            $ref: "#/definitions/PersistenceStatus"
        246:
          $ref: "#/responses/246"
        400:
          $ref: "#/responses/400"
        403:
          $ref: "#/responses/403"
        404:
          $ref: "#/responses/404-datastore-key"
        422:
          $ref: "#/responses/422"
        429:
          $ref: "#/responses/429"      
  /guids:
    put:
      summary: Generate new GUIDs for user's data.
      description: |
        Replace current GUIDs by new generated GUIDs.  Tie the new GUIDs to the authenticated [identity](glossary.html#identity) making this call.

        All data owned by the [identity](glossary.html#identity) on the corresponding distributed persistence network--as per the provided current GUID--is tied to the new GUIDs.  
        New GUIDs are initialized by the broker and bound by this broker to the user.

        This operation is useful to ensure no other broker can alter your data after a [broker transfer](#operation--opt-in-data--type-key---guid--post).  All other [stewards of your data](#tag-data-stewardship) will need to be [made aware of the GUID change](#operation--opt-in-data--type-key---guid--post).

        If this broker is not an [active steward](#operation--active-stewardship-put) of data for [identity](glossary.html#identity), call fails with a 400 -- "cannot write, broker not an active steward of user's data".  Note that [pour-active-stewards](#operation--pour-active-stewardship-put) are considered *passive* stewards for this call.
      tags:
        - data-stewardship
      parameters:
        - in: path
          name: guid
          required: true
          description: |
            A *GUID* as returned by [GET/guids](#operation--guids-get) on this broker.  On success, this GUID--as well as GUIDs representing the same distributed persistence network as this GUID--will be replaces with a new GUID.
          type: string
      security:
        - Authorization Header: []
      consumes:
        - application/json
      produces:
        - application/json
      responses:
        200:
          description: |
            List of new *GUID* pairs.  Only GUIDs corresponding to the parameter GUID are returned: this might be a subset of all user's GUIDs on the broker.
          schema:
            type: array
            items:
              $ref: "#/definitions/GUID"
        400:
          $ref: "#/responses/400"
        403:
          $ref: "#/responses/403"
        429:
          $ref: "#/responses/429"
    get:
      summary: Retrieve GUIDs to user's data on connected persistence networks.
      description: |
        Returns the *GUIDs* pointing to persisted data for the [identity](glossary.html#identity).  This broker must be the owner of whatever
        private metadata is necessary to furnish data to the persistence network at said *GUID*. 

        This getter works in conjunction with the [opt-in-data import POST](#operation--opt-in-data--type-key---guid--post) setter for data pinning/distribution.
      tags:
        - data-stewardship
      security:
        - Authorization Header: []
      produces:
        - application/json
      responses:
        200:
          description: |
            List of *type-key*, *GUID* pairs.  Each *GUID* is mapped to a *type-key*.  
            A *type-key* identifies the type of persistence network the *GUID* is for.  
          schema:
            type: array
            items:
              $ref: "#/definitions/GUID"
        400:
          $ref: "#/responses/400"
        403:
          $ref: "#/responses/403"
        429:
          $ref: "#/responses/429"  
  /latest-snapshot-id/{guid}:
    get:
      summary: Get latest sync-point with persistence network.
      description: |
        Get persisntence network (GUID) specific identifier of latest sync-point between broker and persistence network.

        For [active](glossary.html#data-steward) brokers this is an identifier of the latest write to persistence network.

        For [passive (and pour-active)](glossary.html#data-steward) brokers this is the identifier of the latest snapshot on persistence network that was fully synced to the broker

        This getter works in conjunction with the [opt-in-data import POST](#operation--opt-in-data--type-key---guid--post) setter for data pinning/distribution.
      parameters:
        - in: path
          name: guid
          required: true
          description: |
            A *GUID* as returned by [GET/guids](#operation--guids-get) on this broker.  
          type: string
      tags:
        - data-stewardship
      security:
        - Authorization Header: []
      produces:
        - test/plain
      responses:
        200:
          description: |
            The identifier.
        400:
          $ref: "#/responses/400"
        403:
          $ref: "#/responses/403"
        429:
          $ref: "#/responses/429"  
definitions:
  RemunerationKey:
    type: string
    description: |
      Tag representing a ledger network on which all addresses operate: [user-address](glossary.html#user-address), [broker-address](glossary.html#broker-address), [service-address](glossary.html#service-address), and [invitee/visitor](glossary.html#invitee) addresses.

      **Accepted Values:**

      | *Remuneration Key* | *Network* | *Notes* |
      | --- | --- | --- |
      | ETH | Ethereum *mainnet* | [API link](https://ethereum.overhide.io/swagger.html) |
      | RINKEBY | Ethereum *rinkeby* testnet | [API link](https://rinkeby.ethereum.overhide.io/swagger.html) |
      | OH-LEDGER | *overhide-ledger* | [API link](https://ohledger.com/swagger.html) |
      | OH-LEDGER-TEST | *overhide-ledger* test network | [API link](https://test.ohledger.com/swagger.html) |

  GUID:
    type: object
    description: |
      *Globally Unique ID* -- An identifier globally unique on a particular network: identifies a user's data on the persistence network.
    required:
      - type-key
      - guid
    properties:
      type-key:
        type: string
        enum: [ipns-ri]
        description: |
          Identifies the network this *GUID* is for.

          Type      | Notes
          ---       | ---
          ipns-ri   | An [*overhide* reference implementation](https://github.com/JakubNer/overhide-broker) GUID as per [using IPNS](https://github.com/JakubNer/overhide/blob/master/docs/decentralization.md).  `guid`  value will be in the format `<IPNS name>:<private-key>`, where `<IPNS name>` is the public hash visible to all, `<private-key>` must not be shared, it's included to share with other brokers to enable their custody of *identities* data.
      guid:
        type: string
        description: |
          The identifier for given network.
  Transaction:
    type: object
    required:
      - transaction-value
      - transaction-date
    properties:
      transaction-value:
        type: number
        description: |
          Value of the transaction.
      transaction-date:
        type: string
        description: |
          Date-time timestamp of the transaction.

          The date-time is a string in [ISO 8601/RFC3339 format](https://xml2rfc.tools.ietf.org/public/rfc/html/rfc3339.html#anchor14).
  RemunerationProvider:
    type: object
    required:
      - key
      - broker-address
      - description-md
    properties:
      key:
        type: string
        description: |
          Remuneration provider identifying key string.
      broker-address:
        type: string
        description: |
          This broker's specific public payment address with the reumneration
          provider.  This is the public address to which a subscription payment
          needs to be made from a user [identity](glossary.html#identity).
      description-md:
        type: string
        description: |
          Description Markdown formatted text for this remuneration provider.
          Can have links and other markdown directing user to more information
          about this remuneration provider.
  RemunerationTier:
    type: object
    required:
      - key
      - description-md
    properties:
      key:
        type: string
        description: |
          Remuneration provider's tier identifying key string.
      description-md:
        type: string
        description: |
          Description Markdown formatted text for this remuneration tier.
          Can have links and other markdown directing user to more information
          about this remuneration provider tier.
  Authorities:
    type: object
    required:
      - read-rate
      - write-rate
      - storage-used
      - storage-limit
      - active-until
      - available-until
    properties:
      read-rate:
        type: integer
        description: |
          Maximum amount of data allowed to be read per unit time for the provided
          identity:  in bytes/hour.

          If client's read-rate is reached within an hour, reads are throttled.
          Throttling is broker implementation specific.

          If negative, the rate is unlimited.
      write-rate:
        type: integer
        description: |
          Maximum amount of data allowed to be written per unit time for the provided
          identity: in bytes/hour.

          If client's write-rate is reached within an hour, writes are throttled.
          Throttling is broker implementation specific.

          If negative, the rate is unlimited.
      storage-used:
        type: integer
        description: |
          Amount of data in bytes stored by this [identity](glossary.html#identity) on this broker system.
      storage-limit:
        type: integer
        description: |
          Maximum amoun tof data in bytes that can be stored by this [identity](glossary.html#identity) on this
          broker system at the current subscription level.

          If negative, storage is unlimited.
      active-until:
        type: string
        description: |
          Date-time until when this [identity](glossary.html#identity) has an 'active' subscription at the currently
          authorized level.

          It's possible once this subscription level expires the [identity](glossary.html#identity) continues to
          hava a subscription at a reduced level.  A subscription level expiry indicates
          some remuneration provider transaction to the broker has lapsed.  The  remuneration provider
          might indicate other transactions to the broker that haven't expired.

          The date-time is a string in [ISO 8601/RFC3339 format](https://xml2rfc.tools.ietf.org/public/rfc/html/rfc3339.html#anchor14).

          A 'null' value indicates no expiry of current subscription level.
      available-until:
        type: string
        description: |
          Date-time until when data belonging to this [identity](glossary.html#identity) will be retained within the
          broker system.

          The date-time is a string in [ISO 8601/RFC3339 format](https://xml2rfc.tools.ietf.org/public/rfc/html/rfc3339.html#anchor14).

          A 'null' value indicates no expiry; data retained indefinitely.
  DatastoreKeySettings:
    type: object
    required:
      - allow-write
      - allowed-writers
      - allow-publish
      - allowed-publishers
      - allow-delegation
      - allowed-delegates
      - allow-publish-all-delegates
      - allow-read-all-delegates
      - entry-fee
      - limit-bytes
      - limit-others-read-rate
      - limit-others-write-rate
      - delegate-data-ttl-seconds
      - opt-in
    properties:
      allow-write:
        type: string
        enum: [self, signed, invitee]
        description: |
          Indicate who is allowed to write to the [datastore-key](glossary.html#datastore-key).  The "self" value is default and means only owner of [segment-key](glossary.html#segment-key) has write rights.

          Value of "signed" indicates *allowed-writers* property must necessairly list [identities](glossary.html#identity) allowed to write into this [segment-key](glossary.html#segment-key).  
          Other users using this broker system attempting to write to this [segment-key](glossary.html#segment-key) have their *authentication token* checked against 
          the [identities](glossary.html#identity) in *allowed-writers* list.  These could be real authenticated
          broker [identities](glossary.html#identity) or [invitee *identities*](#operation--auth-guest-credentials-put).

          Value of "invitee" indicates an invitee of this [identity](glossary.html#identity) is allowed to write, see
          the [guest credentials endpoint](#operation--auth-guest-credentials-put): no *allowed-writers* check.
      allowed-writers:
        type: array
        items:
          type: object
          required:
            - identity
          properties:
            identity:
              type: string
              description: |
                [identity](glossary.html#identity) identifying user allowed to write data.
        description: |
          If *allow-write* is "self" this parameter is ignored.

          If *allow-write* is "signed", this parameter is a list of [identities](glossary.html#identity) to identify users allowed to write data to this [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)).
          These could be real authenticated broker [identities](glossary.html#identity) or [invitee *identities*](#operation--auth-guest-credentials-put). 

          Other users using this broker system attempting to write to this [segment-key](glossary.html#segment-key) have their *authentication token* checked against the [identities](glossary.html#identity) in this list.
      allow-publish:
        type: string
        enum: [self, any, signed, invitee]
        description: |
          Indicate who is allowed to publish messages to the [datastore-key](glossary.html#datastore-key)'s backchannel'.  The "self" value is default and means only owner of [segment-key](glossary.html#segment-key) has publish rights.

          Value of "signed" indicates *allowed-publishers* property must necessairly list [identities](glossary.html#identity) allowed to publish messages into this [segment-key](glossary.html#segment-key).  
          Other users using this broker system attempting to publish to this [segment-key](glossary.html#segment-key) have their *authentication token* checked against 
          the [identities](glossary.html#identity) in *allowed-publishers* list.  These could be real authenticated
          broker [identities](glossary.html#identity) or [invitee *identities*](#operation--auth-guest-credentials-put).

          Value of "invitee" indicates an invitee of this [identity](glossary.html#identity) is allowed to publish, see
          the [guest credentials endpoint](#operation--auth-guest-credentials-put).
      allowed-publishers:
        type: array
        items:
          type: object
          required:
            - identity
          properties:
            identity:
              type: string
              description: |
                [identity](glossary.html#identity) identifying user allowed to write data.
        description: |
          if *allow-publish* is "self" or "any" this parameter is ignored.

          If *allow-publish* is "signed", this parameter is a list of [identities](glossary.html#identity) to identify users allowed to publish messages to this [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)).
          These could be real authenticated broker [identities](glossary.html#identity) or [invitee *identities*](#operation--auth-guest-credentials-put).

          Other users using this broker system attempting to publish to this [segment-key](glossary.html#segment-key) have their *authentication token* checked against the [identities](glossary.html#identity) in this list.
      allow-delegation:
        type: string
        enum: [none, any, signed, invitee]
        description: |
          Indicate who is allowed to [write data](#tag-delegate) to this [segment-key](glossary.html#segment-key) as a delegate
          and who's allowed to work with delegate-qualified backchannels on this [segment-key](glossary.html#segment-key):  it's
          the same group.

          Value of "signed" indicates *allowed-delegates* property must necessairly list [identities](glossary.html#identity) allowed to act as delegates for this [segment-key](glossary.html#segment-key).  Delegates attempting to use this [segment-key](glossary.html#segment-key) have their [identity](glossary.html#identity) checked against the *allowed-delegates* list.

          Value of "invitee" indicates an invitee of this [identity](glossary.html#identity) are allowed to be delegates, see
          the [guest credentials endpoint](#operation--auth-guest-credentials-put).
      allowed-delegates:
        type: array
        items:
          type: object
          required:
            - identity
          properties:
            identity:
              type: string
              description: |
                [identity](glossary.html#identity) identifying user allowed to become delegates.
        description: |
          if *allow-delegation* is "none" or "any" this parameter is ignored.

          If *allow-delegation* is "signed", this parameter is a list of [identities](glossary.html#identity) to identify users allowed to be delegates for this [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)).
          These could be real authenticated broker [identities](glossary.html#identity) or [invitee *identities*](#operation--auth-guest-credentials-put).

          Delegates attempting to use this [segment-key](glossary.html#segment-key) have their *authentication token* checked against the [identities](glossary.html#identity) in this list.  
      allow-others-publish-all-delegates:
        type: boolean
        description: |
          If `true` [backchannel message posting](#operation-post-message-WIRE) allows messages publishing to all delegates by non-owner--the glob `*` value for the event's *delegate* parameter can be used by all *allowed-publishers*.
      allow-others-read-all-delegates:
        type: boolean
        description: |
          If `true` allows non-owners to use the ["get all delegate values"](#operation-get-all-delegate-values-WIRE) event.
      entry-fee:
        type: array
        items:
          type: object
          required:
            - value
            - since
            - remuneration-key
          properties:
            value:
              type: number
              description: |
                Amount of currency--as per [remuneration-key](#/definitions/RemunerationKey) required to be able to write/publish to this [segment-key](glossary.html#segment-key).
            since:
              type: string
              description: |
                The remuneration *value* must accumulate in transactions since this date-time (inclusive) until now.

                The date-time is a string in [ISO 8601/RFC3339 format](https://xml2rfc.tools.ietf.org/public/rfc/html/rfc3339.html#anchor14).
            remuneration-key:
              type: string
              description: |
                One of the remuneration provider [keys](#/definitions/RemunerationKey) from /capabilities/remuneration-providers

                The provided address corresponds to one of the remuneration providers, define it.
        description: |
          if *allow-publish* or *allow-write* is "self", "any", "signed" this parameter is ignored.

          If *allow-publish* or *allow-write* is "invitee", this parameter the minimum remuneration value required to be able to write the write/publish operations
          on this [segment-key](glossary.html#segment-key).      
      duplicate-delegate-policy:
        type: string
        description: |
          If a delegate is a [visitor](#operation--auth-guest-credentials-put), the delegate might provide a different *invitee-secret-phrase* for the same *invitee-user-address*.  To prevent the same *invitee-user-address* from using multiples of a *datastore-key's* delegate allotment, this policy may be enforced.

          Note: enforcement of this policy is dependant on a broker-specific hash of the *invitee-user-address* being available in the [visitor's authentication token](#security-definition-Authorization%20Header).  This hashed *invitee-user-address* is not stored off outside the broker's metadata (i.e. on the distributed persistence network). 

          What should the system do if a visitor delegate attempts to use the same *invitee-user-address* with a different visitor [identity](glossary.html#identity)?  Allowed values:

          | *key* | *description* |
          | ---   | ---  |
          | "replace-identity" | replace the previous identity associated with *invitee-user-address* by this new currently-used one |
          | "keep-all" | allow delegate storage for all identities of the same *invitee-user-address* |

          Note that this policy is a complement to the *delegate-data-ttl-seconds* configuration point.
      limit-bytes:
        type: number
        description: |
          Maximum number of bytes of total content allowed for this [segment-key](glossary.html#segment-key) (if not delegated) or per delegate of this [segment-key](glossary.html#segment-key) (if delegated).  This includes the written value as well as all published messages.  If the [segment-key](glossary.html#segment-key) has delegates, the value is per delegate:  the actual limit is multiplied by the number of delegates.
      overlimit-publish-action:
        type: string
        description: |
          What should the system do if *limit-bytes* is exceeded on a message publish?  Allowed values:

          | *key* | *description* |
          | ---   | ---  |
          | "reject" | reject the message publish with error |
          | "drop-newest" | publish the message but drop newest messages to make space |
          | "drop-oldest" | publish the message but drop oldest messages to make space |
      limit-others-read-rate:
        type: number
        description: |
          Maximum rate of bytes/hour each user, other than the owner,is allowed to read at from this [segment-key](glossary.html#segment-key).

          Once reached by a user, reads might drop in priority, be throttled, or be denied with a 403 response code
      limit-others-write-rate:
        type: number
        description: |
          Maximum rate of bytes/hour each user, other than the owner,is allowed to write or publish at to this [segment-key](glossary.html#segment-key).

          Once reached by a user, writes might drop in priority, be throttled, or be denied with a 403 response code
      limit-delegates:
        type: number
        description: |
          Number of delegates allowed for the [segment-key](glossary.html#segment-key).
      delegate-data-ttl-seconds:
        type: number
        description: |
          Time-to-live--in seconds--of [delegate data](#tag-delegate) before it is elegible for cleanup.  Refreshed on any activity on the [segment-key](glossary.html#segment-key) qualified by the delegate.  
      opt-in:
        type: boolean
        description: |
          Opt-in this [segment-key](glossary.html#segment-key) to be stored on this broker's decentralized persistence.  
  Metrics:
    type: object
    required:
      - last-change-unix-time
      - value-storage-bytes
      - value-read-count
      - value-write-count
      - messages-storage-bytes
      - messages-count
      - messages-acknowledged
      - delegates-count
      - delegate-values-storage-bytes
      - delegate-values-read-count
      - delegate-values-write-count
      - delegate-messages-storage-bytes
      - delegate-messages-count
      - delegate-messages-acknowledged
    properties:
      last-change-unix-time:
        type: number
        description: |
          Unix-time (seconds since January 1, 1970 UTC) of last modification of any kind.
      value-storage-bytes:
        type: number
        description: |
          Size in bytes of the data area; sans backchannel or delegates.
      value-read-count:
        type: number
        description: |
          Count of data area read operations; sans backchannel or delegates.
      value-write-count:
        type: number
        description: |
          Count of data area write operations; sans backchannel or delegates.
      messages-storage-bytes:
        type: number
        description: |
          Size in bytes of the backchannel messages; sans delegates.
      messages-count:
        type: number
        description: |
          Count of backchannel messages; sans delegates.
      messages-acknowledged:
        type: number
        description: |
          Count of acknowledged backchannel messages; sans delegates.
      delegates-count:
        type: number
        description: |
          Count of delegate identities using storage in any way.
      delegate-values-storage-bytes:
        type: number
        description: |
          Size in bytes of the delegate data area; sans backchannel.
      delegate-values-read-count:
        type: number
        description: |
          Count of delegate data area read operations; sans backchannel.
      delegate-values-write-count:
        type: number
        description: |
          Count of delegate data area write operations; sans backchannel.
      delegate-messages-storage-bytes:
        type: number
        description: |
          Size in bytes of the delegate backchannel messages.
      delegate-messages-count:
        type: number
        description: |
          Count of delegate backchannel messages.
      delegate-messages-acknowledged:
        type: number
        description: |
          Count of acknowledged backchannel messagess.
  PersistenceStatus:
    type: object
    required:       
      - working-memory
      - permanent-memory
      - shared-memory
    properties:
      working-memory:
        type: string
        description: |
          SHA256 content hash as '0x' prefixed upper-case hex string of the value in the broker's volatile memory.
      permanent-memory:
        type: string
        description: |
          SHA256 content hash as '0x' prefixed upper-case hex string of the value in the broker's volatile memory.
      shared-memory: 
        type: string
        description: |
          SHA256 content hash as '0x' prefixed upper-case hex string of the value in the broker's volatile memory.
  Message:
    type: object
    required:
      - unixtime-millis
      - message
    properties:
      unixtime-millis:
        type: integer
        description: |
          Non-unique UNIX Epoch timestamp (milliseconds) of the message.
      message:
        type: string
        description: |
          The message byte stream base64 encoded.
  ImportExportPayload:
    type: object
    required:
      - settings
      - values
      - messages
    properties:
      settings:
        type: array
        items:
          type: object
          description: |
            Settings for datastore-key to transfer.
          required:
            - segment-key
            - settings
          properties:
            segment-key:
              type: string
              description: |
                See [glossary](glossary.html#segment-key).
            identity:
              type: string
              description: |
                Optional identity.  If provided, must be one of public restricted identities:  0 .. 9999.  If not provided, identity is that of token owner.

                See [glossary](glossary.html#identity).
            settings:
              $ref: "#/definitions/DatastoreKeySettings"
      values:
        type: array
        items:
          type: object
          description: |
            Datastore values to transfer.
          required:
            - segment-key
            - bytes
          properties:
            segment-key:
              type: string
              description: |
                See [glossary](glossary.html#segment-key).
            identity:
              type: string
              description: |
                Optional identity.  If provided, must be one of public restricted identities:  0 .. 9999.  If not provided, identity is that of token owner.

                See [glossary](glossary.html#identity).
            delegate:
              type: string
              description: |
                If value is for a delegate of this [segment-key](glossary.html#segment-key), this is the delegate's identity.
            bytes:
              type: string
              description: |
                The data byte stream base64 encoded.
      messages:
        type: array
        items:
          type: object
          description: |
            All messages from the backchannel at the givent datastore-key

            Messages enqueued at [datastore-key](glossary.html#datastore-key) ([segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)) ordered by increasing non-unique *unixtime-millis*.

            Messages returned may not have unique *unixtime-millis*--more than one message may have the same *unixtime-millis*.  

            The broker guarantees that the messages in the payload comprise *all* unacknowledged message with a *unixtime-millis* 
            up-to and including the highest *unixtime-millis*.
          required:
            - segment-key
            - messages
          properties:
            segment-key:
              type: string
              description: |
                See [glossary](glossary.html#segment-key).
            identity:
              type: string
              description: |
                Optional identity.  If provided, must be one of public restricted identities:  0 .. 9999.  If not provided, identity is that of token owner.

                See [glossary](glossary.html#identity).
            delegate:
              type: string
              description: |
                If messages are for a delegate of this [segment-key](glossary.html#segment-key), this is the delegate's identity.
            messages:
              type: array
              items:
                $ref: "#/definitions/Message"

responses:
  WIRE:
    schema:
      type: object
      required:
        - req-id
        - len
        - total-fragments
        - code
        - response
      properties:
        req-id:
          type: number
          description: |
            Request ID of the request this response/subscription event corresponds to.
        len:
          type: number
          description: |
            Length in bytes of this response message:  length(response) + 6 bytes.
        total-fragments:
          type: number
          description: |
            Total number of messages constituting all fragments for this response.  
            
            For unfragmented responses this value is 1.

            For fragment responses (*code 206* followed by a *code 200*) this value may be useful to gauge progress of receiving the full response: tally of already received versus this value.
        code:
          type: number
          description: |
            One of the WIRE protocol response codes. 

            They roughly match HTTP response codes.

            Refer to the *RESPONSES* section of each particular *WIRE* event for a description of possible *code* values in this corresponding response event.
        response:
          type: bytes
          description: |
            For most error *codes* this is a UTF-8 encoded string with error text.

            For *codes* *200*, [*206*](#/responses/206), *222*, [*246*](#/responses/246), and *413*, this is a response byte-stream.
            
            Each *WIRE* event's *RESPONSES* section details which response *codes* apply; specifying the syntax and semantics of this *response* byte-stream descriptor.

            **Codes 200 and [206](#/responses/206)**
            
            *Code 200* signifies the response is complete.  For unfragmented responses only one response message is returned and it has a *code* of *200*.  A fragmented response returns one or more [*code 206*](#/responses/206) events followed by a final *code 200* response; signalling end of fragments--at which point the aggregate payload can be reconstituted.  

            For [*code 206*](#/responses/206) the *response* is a non-final fragment of an aggregate response.  A [*code 206*](#/responses/206) event from the broker needs to be [acknowledged](#operation-acknowledge-WIRE) by the client.

            **[Code 246](#/responses/246)**

            Under certain conditions [*code 246*](#/responses/246) will be returned instead of *code 200*.  Both *code 200* and [*code 246*](#/responses/246) signify successful completion of a response.

            See section on [*code 246*](#/responses/246) for the *decision matrix* of when the *code* is returned instead of *code 200*.
      description: |
        WebSocket Requests may have one or more response events (this).  Each response event from the *overhide* broker is a byte-stream in the following format:

        | *syntax *       | *bytes* | *value* |
        | ---             | ---     | ---     |
        | req-id          | 8       |         |
        | len             | 8       | length(response) + 6 |
        | total-fragments | 4       |         |
        | code            | 2       |         |
        | response        | *       | ``      |
        
  206:
    description: |
      A fragment of the full response.  Payload byte-stream to reconstitute--in-order--into the aggregate as described by the *200* response code.

      Subsequent *206* responses may follow--in-order for reconstituting the response byte stream--until the aggregate response is finalized with a *200* response code.

      Every *206* response must be [acknowledged](#operation-acknowledge-WIRE) by the client before the broker will send subsequent fragments.
  246:
    description: |
      Inconclusive - check other broker for newer data.

      The *246* status code has the same structure as a *200/OK* and indicates success, but requires caller to second-guess this result.  
      
      It is always returned by *getter calls* on: 

      * [passive hosts](#tag-data-stewardship) in cases where an [active host](#tag-data-stewardship) would return a *200/OK*.
      * [pour-active-stewardship hosts](#operation--pour-active-stewardship-put) when request is for data in a [segment-key](glossary.html#segment-key) that hasn't been explicitly written to via [data](#tag-data), [backchannel](#tag-backchannel-queues), or [scratch-pad](#operation--scratch-pad-put) APIs.  Once a [segment-key](glossary.html#segment-key) is written to by one of these APIs--since the broker was put into [*pour-active-stewardship*](#operation--pour-active-stewardship-put) mode for an [identity](glossary.html#identity)--the [*pour-active-steward*](#operation--pour-active-stewardship-put) will return a *200/OK*.

      Upon receipt of a *246* status code as a response to a *getter call* the client must check whichever complementary broker is reported by [broker-lookup](#tag-broker-lookup)--if any.  A complementary broker to an [*active* *pour* host](#operation--pour-active-stewardship-put) is the [*passive* *drain* host](glossary.html#drain-host) and vice versa.  

      Once both complimentary hosts--reported by [broker-lookup](#tag-broker-lookup)--respond with a value and a status code, consult the following decision matrix as to which broker's value to use :

      |  | *200/OK from ACTIVE (pour)* | *246/Inconclusive from ACTIVE (pour)* | *422/Unprocessable from ACTIVE (pour)* | *246/Inconclusive from PASSIVE (drain)* | *ERROR from PASSIVE (drain)* | *PASSIVE (drain) not set* |
      | --- | --- | --- | --- | --- | --- | --- |
      | *200/OK from ACTIVE (pour)* | X | X | X | use ACTIVE's value | use ACTIVE's value | use ACTIVE's value |
      | *246/Inconclusive from ACTIVE (pour)* | X | X | X | use PASSIVE's value | use ACTIVE's value | use ACTIVE's value |
      | *422/Unprocessable from ACTIVE (pour)* | X | X | X | use PASSIVE's value | ERROR | ERROR |
      | *246/Inconclusive from PASSIVE (drain)* | use ACTIVE's value | use PASSIVE's value | use PASSIVE's value | X | X | X |
      | *ERROR from PASSIVE (drain)* | use ACTIVE's value | use ACTIVE's value | ERROR | X | X | X |
      | *PASSIVE (drain) not set* | use ACTIVE's value | use ACTIVE's value | ERROR | X | X | X |

      The decision which broker's value to use as source of truth depends on their returned status codes.

  400:
    description: |
      A bad request from the client results in one or more of the following error message strings:

      * invalid remuneration-key, doesn't match broker system capabilities
      * address incompatible with remuneration provider
      * invalid signature
      * invalid secret-phrase
      * no handshake
      * message outside handshake constraints
      * invalid type-key, doesn't match broker system capabilities
      * cannot process input
      * cannot write, broker not an active steward of user's data
          * check broker-lookup to find active steward and write there
      * cannot continue, invalid stewardship mode

      The message enum might be extended by broker system.
  401:
    description: |
      For an endpoint protected with the [token security definition](#security-definition-Authorization Header), an "Authorization" header was not provided a valid token--as returned from the [authenticate endpoint](#operation--auth-credentials-put).
  403:
    description: |
      There is an access violation for this valid and authenticated [identity](glossary.html#identity) against this valid [datastore-key](glossary.html#datastore-key).

      1. The authenticated [identity](glossary.html#identity) has insufficient access rights to this valid [datastore-key](glossary.html#datastore-key) for the operation.  Review the [access rights](#definition-DatastoreKeySettings) as manipulated with the [settings endpoints](#tag-datastore-key-settings).
      1. The API request would exceed rates and limits as set out within the authorities at the current [subscription plan](#operation--capabilities--remuneration-key--tiers-get) or [datastore-key](glossary.html#datastore-key) [entry-fee](#definition-DatastoreKeySettings).

      Errors equally apply to "inviee" *identities*.

      Results in one or more of the following error message strings:

      - no write access
      - no publish access
      - storage limit exceeded
      - read-rate exceeded
      - write-rate exceeded
        
      The message enum might be extended by broker system.

      Broker systems might not throw up this response when read and write rates are exceeded.  Instead a broker system might start throttling responses or responding at a lower-priority.
  404-datastore-key: 
    description: |
      Invalid datastore-key requested; [segment-key](glossary.html#segment-key) or [identity](glossary.html#identity) mismatch.
  404-cannot-resolve: 
    description: |
      Cannot resolve address.
  405: 
    description: |
      Method not allowed.

      The [broker-lookup](#tag-broker-lookup) subsystem is not provided/enabled by this broker.
  409-identity-conflict:
    description: |
      Go play a lottery:  the generated identity conflicts with some other identity or ended up being a restricted number <10000.

      [user-address](glossary.html#user-address) hashed with its *secret-phrase* must be unique within the system.  Another [user-address](glossary.html#user-address)/*secret-phrase* already in the system hashes to the same hash as the provided [user-address](glossary.html#user-address)/*secret-phrase*.

      Try a different *secret-phrase*.
  409:
    description: |
      Setter encountered a conflict.  Consult error message:

      * write-conflict:

          Occurs when a data set operation includes a *write-gate* parameter that has a SHA256 value which does not match the SHA256 hash of the current (in-datastore) value of a [segment-key](glossary.html#segment-key).

          A data write is requested on a [segment-key](glossary.html#segment-key) that has an unexpected value in the datastore.  Implies there is a concurrent write issue. 

      * datastore-key conflict:

          Datastore-key ownership conflict; [segment-key](glossary.html#segment-key) @ [identity](glossary.html#identity)  already reserved.
  422:
    description: |
      Unprocessable - not filled yet, check draining host for data.

      When a *getter* method called on a [pour-active-steward](#operation--pour-active-stewardship-put) doesn't find a [segment-key](glossary.html#segment-key) for an [identity](glossary.html#identity) it returns this status code instead of a 400/BAD-REQUEST (with "invalid datastore-key requested; segment-key or identity mismatch" for the reason).

      Upon receipt of a *422* status code as a response to a *getter call* the client must attempt the *getter call* with the complementary [*draining* *passive* broker](glossary.html#drain-host) as reported by [broker-lookup](#tag-broker-lookup)--if any.

      Refer to write-up on the [*246* status code](#/responses/206) for a decision matrix as to what the client should do.
  429:
    description: |
      Client is calling the API too frequently.

      Conditions for this response to occur are broker system dependant.
  502:
    description: |
      Cannot reach data.
securityDefinitions:
  Authorization Header:
    type: apiKey
    in: header
    name: Authorization
    description: |
      Provides an authentication token as retrieved with either the [authentication endpoint](#operation--auth-credentials-put)
      or the [invitee credentials endpoint](#operation--auth-guest-credentials-put).

      The token returned by either call must be provided in an "Authorization" header to HTTPS calls secured with this security definition.

      The tokens are whitelisted by the *overhide* broker until revoked or expired (at broker's purview).  
      
      The token contains the [identity](glossary.html#identity)--hashed in implementation specific ways--to help with access control for the rest of the API.  
      
      Details in the [*identity write-up*](glossary.html#identity#authenticated-sessions).
  Authorization WSS:
    type: apiKey
    in: query
    name: auth
    description: |
      Provides an authentication token as retrieved with either the [authentication endpoint](#operation--auth-credentials-put)
      or the [invitee credentials endpoint](#operation--auth-guest-credentials-put).

      For WSS, the token must be provided when establishing the connection:

      ```
        WebSocket = require 'ws'
        ws = new WebSocket 'ws://localhost:8000',{
          headers : {
            token: "..."
          }
        }
      ```

      Token details are same as per the [Authorization Header](#security-definition-Authorization Header) security scheme.
externalDocs:
  description: overhide documentation
  url: 'https://pages.github.com/JakubNer/overhide'
